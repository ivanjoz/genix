import{a as N,c as d,d as Z,i as t,S as M,f as I,b as L,t as a,g as ee,o as re,e as U}from"./web-D7Y7EE6c.js";import{c as V,M as B,t as se,e as E,I as T,S as te,g as oe,h as ce,P as le,N as G,L as D}from"./app-DUJ9K0SH.js";import{s as O,C as ne,M as H}from"./Modals-CKgl12JL.js";import{Q as ae}from"./QTable-CvEM_gjE.js";import{d as ie,e as de,f as ue,g as me}from"./empresas-BPLc5_U6.js";var fe=a('<button class="bnr2 b-blue"><i class=icon-pencil>'),pe=a("<span class=c-red>(Modo Edición)"),ve=a("<span class=mr-04>:"),ge=a('<span class="c-purple2 ml-04">'),he=a('<button class="bn1 b-white">'),be=a('<div class="flex jc-between w100"><div class="ff-bold h2"><span class="">Accesos</span></div><div class="flex ai-center m-corner-r">'),$e=a('<div class="box-error-ms mb-08 w-fit">Debe seleccionar un perfil para editar sus accesos.'),_e=a('<div class="flex jc-between mb-06"><div class=""><div class="flex jc-between w100 mb-10"><div class="search-c4 mr-16 w16rem"><div><i class=icon-search></i></div><input class=w100 autocomplete=off type=text></div><div class="flex ai-center"><button class="bn1 b-green"><i class=icon-plus></i></button>'),ye=a('<div class="flex-wrap w100-10"><div class="flex ai-center line-c1 w-24x mb-04"><div></div><div class="ff-bold h3">Acciones</div><div>'),we=a('<div class="flex-wrap w100-10">'),Pe=a('<button class="bn1 b-green mr-08"><i class=icon-plus>'),xe=a('<button class="bn1 d-blue"><i class=icon-floppy></i><span class=m-hide>Guardar'),Ce=a('<i class="c-red icon-cancel">'),ke=a("<i class=icon-pencil>"),Ae=a('<div class="ff-bold c-purple4 h5"> > '),Me=a("<div class=flex-wrap>"),Ee=a('<div class="line-1 p-abs">'),Se=a('<div class="p-abs flex-center bn1 i-edit"><i class=icon-pencil>'),Ie=a('<div class="p-abs flex-center a-id c-purple3">'),De=a("<div class=acciones-ac1>"),Oe=a('<div class="acciones-ac2 w100 flex jc-center z10">'),Ne=a("<div><div class=mr-04>"),Le=a("<div class=bnc1><i>"),Te=a('<div class="flex-center h5 ff-bold lh-10">');const K=[{id:1,name:"Gestión"},{id:2,name:"Seguridad"},{id:3,name:"Maestros"},{id:4,name:"Productos"},{id:5,name:"Reportes"}],J=[{id:1,name:"Visualizar",short:"VER",icon:"icon-eye",color:"#00c07d",color2:"#49c99c"},{id:2,name:"Editar",short:"EDITAR",icon:"icon-pencil",color:"#0080f9"},{id:3,name:"Eliminar",short:"ELIMINAR",icon:"icon-trash",color:"#0080f9"},{id:7,name:"Todo",short:"EDITAR",icon:"icon-shield",color:"#af12eb",color2:"#d35eff"}],z=V(J,"id");function Ve(){const[c,C]=ie(),[k,F]=de(),j=V(K,"id"),f=V(B,"id"),[v,o]=N({}),[r,u]=N({}),[g,y]=N(0),[h,m]=N(""),[p,R]=N(!1),W=()=>{const e=new Map,i=g();for(let $ of c())for(let _ of $.modulosIDs){if(i&&i!==_)continue;const w=[_,$.grupo].join("_");e.has(w)||e.set(w,[]),e.get(w).push($);break}const n=[];for(let[$,_]of e){const[w,P]=$.split("_").map(S=>parseInt(S));n.push({moduleID:w,group:P,accesos:_,groupName:j.get(P)?.name||"",moduleName:i?"":f.get(w)?.name||""})}return n},X=[{header:"ID",headerStyle:{width:"2.6rem"},css:"c c-purple2",getValue:e=>e.id},{header:"Perfil",field:"nombre",getValue:e=>e.nombre,cardColumn:[1,1]},{header:"...",headerStyle:{width:"2.6rem"},cardColumn:[1,2],render:e=>(()=>{var i=fe();return i.$$click=n=>{n.stopPropagation(),u({...e}),O([2])},i})()}],Y=async()=>{const e=v();if(!e.nombre||!e.orden||(e.acciones?.length||0)==0||!e.grupo||(e.modulosIDs.length||0)===0){G.failure("Faltan propiedades para agregar el acceso.");return}D.standard("Actualizando Acceso...");try{var i=await ue(e)}catch(_){G.failure(_),D.remove();return}D.remove(),console.log("acceso resultado::",i);let n=[...c()];(e.id||0)<=0&&(e.id=i.id);const $=n.find(_=>_.id===e.id);$?Object.assign($,e):c().push(e),o({}),C([...c()]),O([])},Q=async(e,i)=>{const n=r();if(!n.nombre){G.failure("Faltan propiedades para agregar el acceso.");return}if(i){n.accesos=[];for(let[s,l]of n.accesosMap){l.length===0&&n.accesosMap.delete(s);for(let b of l)n.accesos.push(s*10+b)}const P=c().filter(s=>n.accesosMap.has(s.id)),S=new Set;for(let s of P)for(let l of s.modulosIDs)S.add(l);n.modulosIDs=[...S]}console.log("perfil:: ",n),D.standard("Actualizando Perfil...");try{var $=await me(n)}catch(P){G.failure(P),D.remove();return}const _=[...k().perfiles];k().perfiles=_,(n.id||0)<=0&&(n.id=$.id);const w=_.find(P=>P.id===n.id);n._open=!1,w?Object.assign(w,n):_.push(n),D.remove(),console.log("perfil resultado::",$),u({}),F({...k()}),O([])};return d(le,{title:"Perfiles & Accesos",fetchLoading:!0,get children(){return[(()=>{var e=_e(),i=e.firstChild,n=i.firstChild,$=n.firstChild,_=$.firstChild,w=_.nextSibling,P=$.nextSibling,S=P.firstChild;return w.$$keyup=s=>{s.stopPropagation(),se(()=>{m((s.target.value||"").toLowerCase().trim())},150)},S.$$click=s=>{s.stopPropagation(),u({ss:1}),O([2])},t(i,d(ae,{css:"selectable w100",columns:X,maxHeight:"calc(100vh - 8rem - 16px)",styleMobile:{height:"100vh"},get data(){return k().perfiles},get selected(){return r().id},get filterText(){return h()},filterKeys:["nombre"],isSelected:(s,l)=>s.id===l,onRowCLick:s=>{s.id===r().id?u({}):u({...s,_open:!0})}}),null),t(e,d(ne,{get showMobileLayer(){return r()._open},get style(){return{width:E()===1?"64.5%":"100%"}},onClose:()=>{u({})},get children(){return[(()=>{var s=be(),l=s.firstChild;l.firstChild;var b=l.nextSibling;return t(l,d(M,{get when(){return p()},get children(){return pe()}}),null),t(l,d(M,{get when(){return r().id>0},get children(){return[ve(),(()=>{var x=ge();return t(x,()=>r().nombre),x})()]}}),null),t(b,(()=>{var x=I(()=>!!p());return()=>x()&&(()=>{var A=Pe();return A.$$click=q=>{q.stopPropagation(),o({ss:1}),O([1])},A})()})(),null),t(b,(()=>{var x=I(()=>r().id>0);return()=>x()&&(()=>{var A=xe();return A.$$click=q=>{q.stopPropagation(),Q(!1,!0)},A})()})(),null),t(b,d(M,{get when(){return!r().id},get children(){var x=he();return x.$$click=A=>{A.stopPropagation(),R(!p())},t(x,(()=>{var A=I(()=>!!p());return()=>A()?Ce():ke()})()),x}}),null),s})(),d(M,{get when(){return I(()=>!p())()&&!r().id},get children(){return $e()}}),I(()=>W().map(s=>[(()=>{var l=Ae(),b=l.firstChild;return t(l,()=>s.moduleName.toUpperCase(),b),t(l,()=>s.groupName.toUpperCase(),null),l})(),(()=>{var l=Me();return l.style.setProperty("margin","0 -8px"),l.style.setProperty("width","calc(100% + 16px)"),t(l,()=>s.accesos.map(b=>d(Fe,{get isEdit(){return p()},acceso:b,get saveOn(){return I(()=>!!r().id)()?r():null},onEdit:()=>{console.log("acceso seleccionado::",b),o({...b}),O([1])}}))),L(()=>l.classList.toggle("px-04",E()!==1)),l})()]))]}}),null),L(s=>{var l=!![2,3].includes(E()),b=E()===1?"34%":"100%";return l!==s.e&&e.classList.toggle("column",s.e=l),b!==s.t&&((s.t=b)!=null?i.style.setProperty("width",b):i.style.removeProperty("width")),s},{e:void 0,t:void 0}),e})(),d(H,{id:1,get title(){return v().id?"Editando Acceso":"Creando Acceso"},css:"w44-64 in-s2",get isEdit(){return!!v().id},onSave:()=>{Y()},onDelete:()=>{},get children(){var e=ye(),i=e.firstChild;return t(e,d(T,{get saveOn(){return v()},save:"nombre",css:"w-14x mb-10",label:"Nombre",required:!0}),i),t(e,d(te,{get saveOn(){return v()},save:"grupo",css:"w-10x mb-10",label:"Grupo",required:!0,options:K,keys:"id.name"}),i),t(e,d(T,{get saveOn(){return v()},save:"descripcion",css:"w-16x mb-10",label:"Descripcion"}),i),t(e,d(T,{get saveOn(){return v()},save:"orden",css:"w-08x mb-10",label:"Orden",type:"number"}),i),t(e,d(oe,{get saveOn(){return v()},save:"modulosIDs",css:"w100 mb-10",label:"Modulos",required:!0,options:B,keys:"id.name"}),i),t(e,d(ce,{save:"acciones",get saveOn(){return v()},css:"w-24x mb-10",options:J,keys:"id.name"}),null),e}}),d(H,{id:2,get title(){return r().id?"Editando Perfil":"Creando Perfil"},css:"w44-64 in-s2",get isEdit(){return!!v().id},onSave:()=>{Q()},onClose:()=>{u({})},onDelete:()=>{},get children(){var e=we();return t(e,d(T,{get saveOn(){return r()},save:"nombre",css:"w-24x mb-10",label:"Nombre",required:!0}),null),t(e,d(T,{get saveOn(){return r()},save:"descripcion",css:"w-24x mb-10",label:"Descripcion"}),null),e}})]}})}const Fe=c=>{const[C,k]=N([]);ee(re(()=>c.saveOn,()=>{k(c.saveOn?.accesosMap?.get(c.acceso.id)||[])}));const F=()=>{if(C().length===0||c.isEdit)return;const f=C();f.sort().reverse();const v=z.get(f[0]||0);return v?.color2||v?.color||""},j=()=>{let f="acceso-card";return c.isEdit&&(f+=" sel"),[2,3].includes(E())&&(f+=" mobile"),f};return(()=>{var f=Ne(),v=f.firstChild;return f.$$click=o=>{if(![1].includes(E()))if(o.stopPropagation(),C().length>=c.acceso.acciones.length)k([]);else{const r=[...C()],u=c.acceso.acciones.filter(g=>!r.includes(g));r.push(u[0]),k(r.filter(g=>g))}},t(v,()=>c.acceso.nombre),t(f,d(M,{get when(){return[2,3].includes(E())},get children(){var o=Ee();return L(r=>(r=F())!=null?o.style.setProperty("background-color",r):o.style.removeProperty("background-color")),o}}),null),t(f,d(M,{get when(){return c.isEdit},get children(){return[(()=>{var o=Se();return o.$$click=r=>{r.stopPropagation(),c.onEdit&&c.onEdit()},o})(),(()=>{var o=Ie();return t(o,()=>c.acceso.id),o})()]}}),null),t(f,d(M,{get when(){return!c.isEdit&&c.saveOn},get children(){return[(()=>{var o=De();return t(o,()=>C().map(r=>{console.log("acciones ids:: ",r);const u=z.get(r);return(()=>{var g=Le(),y=g.firstChild;return L(h=>{var m=u.color,p=u.icon;return m!==h.e&&((h.e=m)!=null?g.style.setProperty("background-color",m):g.style.removeProperty("background-color")),p!==h.t&&U(y,h.t=p),h},{e:void 0,t:void 0}),g})()})),o})(),(()=>{var o=Oe();return t(o,()=>c.acceso.acciones.map(r=>{const u=z.get(r),g=C().includes(r);return(()=>{var y=Te();return y.$$click=h=>{h.stopPropagation();let m=[...C()];m.includes(r)?m=m.filter(p=>p!==r):m.push(r),console.log("seteando acciones:: ",m),m.sort((p,R)=>R-p),m.length===0?c.saveOn.accesosMap.delete(c.acceso.id):c.saveOn.accesosMap.set(c.acceso.id,m),k(m)},(g?"white":void 0)!=null?y.style.setProperty("color",g?"white":void 0):y.style.removeProperty("color"),t(y,()=>u.short),L(h=>{var m=g?u.color:void 0,p=g?u.color:void 0;return m!==h.e&&((h.e=m)!=null?y.style.setProperty("background-color",m):y.style.removeProperty("background-color")),p!==h.t&&((h.t=p)!=null?y.style.setProperty("border-color",p):y.style.removeProperty("border-color")),h},{e:void 0,t:void 0}),y})()})),o})()]}}),null),L(o=>{var r=j(),u=F();return r!==o.e&&U(f,o.e=r),u!==o.t&&((o.t=u)!=null?f.style.setProperty("border-left-color",u):f.style.removeProperty("border-left-color")),o},{e:void 0,t:void 0}),f})()};Z(["click","keyup"]);export{Ve as default};
