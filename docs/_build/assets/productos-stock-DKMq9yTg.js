import{a as i,g as E,c as o,d as q,i as s,S as k,t as l}from"./web-B5q02dNy.js";import{S as w,t as H,n as Q,z as R,a as y,I as _,P as B,L as p,w as U,N as L}from"./app-BWK4gxn2.js";import{C as A}from"./Editables-BusTbSKR.js";import{a as G,b as J}from"./Modals-DvNFUCP8.js";import{Q as W}from"./QTable-BOTD2X_R.js";import{u as X,g as Y,p as Z}from"./productos-B36PFsTO.js";import{u as ee}from"./sedes-almacenes-D6o03K97.js";var te=l('<div class="search-c4 mr-16 w14rem"><div><i class=icon-search></i></div><input class=w100 autocomplete=off type=text>'),re=l('<div class="flex ai-center c-red"><i class=icon-attention></i>Debe seleccionar un almacén.'),ae=l('<button class="bn1 b-blue mr-08"><i class=icon-floppy></i>Guardar (<!>)'),ne=l('<div class="flex ai-center jc-between mb-06"><div class="flex ai-center"></div><div class="flex ai-center"><button class="bn1 b-green"><i class=icon-plus>'),oe=l('<div class="w100-10 flex-wrap in-s2">'),se=l('<div class="flex ai-center jc-end"><div></div><div class="mr-02 ml-02">→</div><div class="c-red ff-bold">'),ce=l('<div class="c-red ff-bold">'),de=l("<i class=icon-ok>");function ve(){const[u,h]=i([]),[C]=X(),[b]=ee(),[I,N]=i({almacenID:0}),[m,O]=i({}),[g,x]=i(-1),[d,P]=i(new Set),[V,K]=i(!1);let S=new Map;const $=async e=>{let t=[];p.standard("Obteniendo Registros...");try{t=await Y(e)}catch{p.remove();return}console.log("productos stock::",t),h(t),U.setValue("almacen_id",e);for(let r of t){const n=[r.ProductoID,r.SKU||"0",r.Lote||"0"].join("_");S.set(n,r)}p.remove()};E(()=>{if(g()==-1&&b()?.Almacenes?.length>0){const e=I();e.almacenID=U.getValueInt("almacen_id")||0,e.almacenID||(e.almacenID=b().Almacenes[0].ID),x(e.almacenID),N({...e}),$(e.almacenID)}});const j=e=>{if(!e.ProductoID||!e.Cantidad){L.failure("Debe seleccionar un producto y asignar una cantidad.");return}const t=[e.ProductoID,e.SKU||"0",e.Lote||"0"].join("_"),r=u();if(d().add(t),S.has(t)){const n=S.get(t);n.Cantidad=e.Cantidad,n.CostoUn=e.CostoUn||n.CostoUn,n._cantidadPrev=n._cantidadPrev||n.Cantidad||-1,n._hasUpdated=!0}else S.set(t,e),r.unshift(e),e._cantidadPrev=-1,e.AlmacenID=g(),e._hasUpdated=!0;P(new Set(d())),h([...r]),O({})},M=async()=>{const e=u().filter(r=>r._hasUpdated);if(e.length===0){L.failure("No hay registros a actualizar.");return}p.standard("Enviando registros...");let t;try{t=await Z(e)}catch{p.remove();return}for(let r of e)r._cantidadPrev=0;console.log("resultado obtenido::",t),h([...u()]),p.remove()},[D,T]=i(""),F=(e,t)=>{const r=new Set(e.map(a=>a.ProductoID)),n=[...e];for(let a of C().productos)r.has(a.ID)||n.push({AlmacenID:t,ProductoID:a.ID,Cantidad:0,_isVirtual:!0});return n};return o(B,{title:"Almacén Stock",get children(){return[(()=>{var e=ne(),t=e.firstChild,r=t.nextSibling,n=r.firstChild;return s(t,o(w,{get saveOn(){return I()},save:"almacenID",css:"w20rem s6 mb-02 mr-12",label:"",keys:"ID.Nombre",get options(){return b()?.Almacenes||[]},placeholder:" ALMACÉN",onChange:a=>{if(x(a?.ID||0),a){$(a.ID);return}}}),null),s(t,o(k,{get when(){return g()>0},get children(){return[(()=>{var a=te(),c=a.firstChild,f=c.nextSibling;return f.$$keyup=v=>{v.stopPropagation(),H(()=>{T((v.target.value||"").toLowerCase().trim())},150)},a})(),o(Q,{label:"Todos Productos",get checked(){return V()},onChange:a=>{K(a);let c=[];a?c=F(u(),g()):c=u().filter(f=>!f._isVirtual),h(c)}})]}}),null),s(t,o(k,{get when(){return!g()},get children(){return re()}}),null),s(r,o(k,{get when(){return d().size>0},get children(){var a=ae(),c=a.firstChild,f=c.nextSibling,v=f.nextSibling;return v.nextSibling,a.$$click=z=>{z.stopPropagation(),M()},s(a,()=>d().size,v),a}}),n),n.$$click=a=>{a.stopPropagation(),G([2])},e})(),o(W,{get data(){return u()},css:"",tableCss:"w-page-t",maxHeight:"calc(80vh - 13rem)",get filterText(){return D()},makeFilter:e=>C().productosMap.get(e.ProductoID)?.Nombre||"",columns:[{header:"Producto",css:"",render:e=>{const t=C().productosMap.get(e.ProductoID)?.Nombre||`P-${e.ProductoID}`;return R(t,D())}},{header:"Lote",css:"c-purple",getValue:e=>e.Lote},{header:"SKU",css:"c-purple",getValue:e=>e.SKU},{header:"Propiedades",css:"",getValue:e=>""},{header:"Stock",cardColumn:[3,2],field:"Nombre",css:"t-r",headerStyle:{width:"8rem"},render:e=>o(A,{saveOn:e,save:"",contentClass:"px-06 flex ai-center jc-end",inputClass:"t-c",type:"number",getValue:()=>e.Cantidad,onChange:t=>{if(e.Cantidad===t)return;e._cantidadPrev=e._cantidadPrev||e.Cantidad||-1,e.Cantidad=parseInt(t||"0"),e._hasUpdated=!0;const r=[e.ProductoID,e.SKU||"0",e.Lote||"0"].join("_");d().add(r),P(new Set(d()))},render:()=>{if(e._cantidadPrev&&e._cantidadPrev!==e.Cantidad){const t=e._cantidadPrev===-1?0:e._cantidadPrev;return(()=>{var r=se(),n=r.firstChild,a=n.nextSibling,c=a.nextSibling;return s(n,t),s(c,()=>e.Cantidad),r})()}else return e.Cantidad?String(e.Cantidad):(()=>{var t=ce();return s(t,()=>e.Cantidad),t})()}})},{header:"Costo UN",cardColumn:[3,2],cardCss:"h5 c-steel",css:"t-c",getValue:e=>e.CostoUn?y(e.CostoUn,2):"",render:e=>o(A,{saveOn:e,save:"CostoUn",contentClass:"px-06 flex ai-center jc-end",inputClass:"t-c",type:"number",onChange:t=>{e._hasUpdated=!0;const r=[e.ProductoID,e.SKU||"0",e.Lote||"0"].join("_");d().add(r),P(new Set(d()))},render:()=>e.CostoUn?y(e.CostoUn,2):""})},{header:"Stock Min",cardColumn:[3,2],cardCss:"h5 c-steel",css:"t-c",getValue:e=>""}]}),o(J,{title:"Nuevo Producto Stock",id:2,css:"py-12 px-12",get buttonSave(){return[de(),"Agregar"]},onSave:()=>{j(m())},get children(){var e=oe();return s(e,o(w,{get saveOn(){return m()},save:"ProductoID",css:"w-24x mb-10",label:"Producto1",keys:"ID.Nombre",get options(){return C()?.productos||[]},placeholder:" ",required:!0}),null),s(e,o(_,{get saveOn(){return m()},save:"SKU",css:"w-16x mb-10",label:"SKU"}),null),s(e,o(_,{get saveOn(){return m()},save:"Cantidad",required:!0,css:"w-08x mb-10",label:"Cantidad",type:"number"}),null),s(e,o(_,{get saveOn(){return m()},save:"Lote",css:"w-16x mb-10",label:"Lote",type:"text"}),null),s(e,o(_,{get saveOn(){return m()},save:"CostoUn",css:"w-08x mb-10",label:"Costo x Unidad",type:"number"}),null),e}})]}})}q(["keyup","click"]);export{ve as default};
