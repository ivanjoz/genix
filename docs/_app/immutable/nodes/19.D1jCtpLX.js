import"../chunks/DsnmJJEf.js";import{p as ne,e as O,g as T,l as H,i as t,m as J,h as c,d as ce,f as k,a as M,c as x,u as U,s as u,r as w,b}from"../chunks/CaHRSXkO.js";import{d as ie}from"../chunks/EZdBy8tr.js";import{s as de,I as A}from"../chunks/C7ON8eMg.js";import{i as V}from"../chunks/BLuAT40e.js";import{P as le}from"../chunks/CdY_1qrk.js";import{S as K}from"../chunks/CVoJ4bp_.js";import{V as ue}from"../chunks/CfB0PGuL.js";import{N as E,t as pe}from"../chunks/C277PxC_.js";import{n as h}from"../chunks/DP6SISrU.js";import{P as ve}from"../chunks/C9Uo9afc.js";import{A as me}from"../chunks/DZ_38WFI.js";import{a as fe,P as ge,C as Q}from"../chunks/DtXTy_F4.js";import{L as _e}from"../chunks/Dmtk3Aq1.js";import{C as he}from"../chunks/R2AuMfvk.js";const Ie=async I=>{let C=[];try{C=await fe({route:`productos-stock?almacen-id=${I}`,errorMessage:"Hubo un error al obtener el stock.",useCache:{min:0,ver:6}})}catch(N){E.failure(N)}return C},Pe=I=>ge({data:I,route:"productos-stock",refreshRoutes:["productos-stock"]});var De=k('<div class="ml-12 c-red"><i class="icon-attention"></i>Debe seleccionar un almacén.</div>'),be=k('<div class="i-search w-full md:w-200 md:ml-12 col-span-5"><div><i class="icon-search"></i></div> <input type="text"/></div> <!>',1),ke=k('<button class="bx-blue mr-8"><i class="icon-floppy"></i>Guardar</button> <button class="bx-green" aria-label="agregar"><i class="icon-plus"></i></button>',1),Ce=k('<div class="grid grid-cols-24 gap-10 mt-6 p-4"><!> <!> <!> <!> <!> <!></div>'),ye=k('<div class="flex items-center mb-8"><!> <!> <div class="ml-auto"><!></div></div> <!> <!>',1);function Ge(I,C){ne(C,!0);const N=new me,f=new ve;let i=O(T({almacenID:0,showTodosProductos:!1})),j=O(""),v=O(T([])),g=[],a=O(T({})),G=U(()=>f?.productosMap?.get(t(a).ProductoID||0));H(()=>{t(i).almacenID});let W=[{header:"Producto",highlight:!0,getValue:e=>f.productosMap.get(e.ProductoID)?.Nombre||""},{header:"Lote",getValue:e=>e.Lote||""},{header:"SKU",getValue:e=>e.SKU||""},{header:"Presentación",getValue:e=>e.PresentacionID&&f.productosMap.get(e.ProductoID)?.Presentaciones?.find(n=>n.id===e.PresentacionID)?.nm||""},{header:"Stock",css:"justify-end",inputCss:"text-right pr-6",getValue:e=>e.Cantidad,onCellEdit:(e,r)=>{F(e,parseInt(r||"0"))},render:e=>e._cantidadPrev&&e._cantidadPrev!==e.Cantidad?{css:"flex items-center",children:[{text:String(e._cantidadPrev>0?e._cantidadPrev:0)},{text:"→",css:"ml-2 mr-2"},{text:e.Cantidad,css:"c-red"}]}:{text:e.Cantidad||""}},{header:"Costo Un.",onCellEdit:(e,r)=>{e._hasUpdated=!0,e.CostoUn=parseInt(r||"0")}}];const X=async()=>{if(t(i).almacenID){h.Loading.standard();try{var e=await Ie(t(i).almacenID)}catch{h.Loading.remove();return}h.Loading.remove(),c(v,e||[],!0),g=e||[]}},Y=async()=>{const e=t(v).filter(s=>s._hasUpdated);if(e.length===0){E.failure("No hay registros a actualizar.");return}h.Loading.standard("Enviando registros...");let r;try{r=await Pe(e)}catch{h.Loading.remove();return}for(const s of t(v))s._cantidadPrev=0;console.log("resultado obtenido::",r),h.Loading.remove()},Z=()=>{console.log("almacenStockGetted",de(g));const e=new Map(g?.map(r=>[r.ID,r]));for(const r of f.productos){const s=r.Presentaciones?.length>0?r.Presentaciones.map(n=>n.id):[0];for(const n of s){const m=[t(i).almacenID,r.ID,n||"","",""].join("_");if(e.has(m)){const $=e.get(m);$.PresentacionID=n;continue}const y={ID:m,AlmacenID:t(i).almacenID,ProductoID:r.ID,PresentacionID:n,Cantidad:0};e.set(m,y)}}c(v,[...e.values()],!0)},F=(e,r)=>{e.ID||(e.ID=[e.AlmacenID,e.ProductoID,e.PresentacionID||0,e.SKU||"",e.Lote||""].join("_"));const s=t(v).find(n=>n.ID===e.ID)||g.find(n=>n.ID===e.ID);s?(s._hasUpdated=!0,s._cantidadPrev=s._cantidadPrev||s.Cantidad||-1,s.Cantidad=r):(e._cantidadPrev=-1,e._hasUpdated=!0,g.unshift(e),t(v).unshift(e),c(v,[...t(v)],!0))};H(()=>{t(i).showTodosProductos?J(()=>{Z()}):J(()=>{c(v,g,!0)})}),le(I,{sideLayerSize:640,title:"productos-stock",children:(e,r)=>{var s=ye(),n=M(s),m=x(n);{let o=U(()=>N?.Almacenes||[]);K(m,{get options(){return t(o)},keyId:"ID",keyName:"Nombre",save:"almacenID",placeholder:"ALMACÉN ::",css:"w-270",onChange:()=>{X()},get saveOn(){return t(i)},set saveOn(p){c(i,p,!0)}})}var y=u(m,2);{var $=o=>{var p=De();b(o,p)},ee=o=>{var p=be(),l=M(p),_=u(x(l),2);_.__keyup=P=>{const L=String(P.target.value||"");pe(()=>{c(j,L,!0)},150)},w(l);var S=u(l,2);he(S,{label:"Todos los Productos",save:"showTodosProductos",css:"ml-16",get saveOn(){return t(i)},set saveOn(P){c(i,P,!0)}}),b(o,p)};V(y,o=>{t(i).almacenID?o(ee,!1):o($)})}var q=u(y,2),te=x(q);{var re=o=>{var p=ke(),l=M(p);l.__click=()=>{Y()};var _=u(l,2);_.__click=()=>{c(a,{AlmacenID:t(i).almacenID},!0),Q.openSideLayer(1)},b(o,p)};V(te,o=>{t(i).almacenID>0&&o(re)})}w(q),w(n);var z=u(n,2);ue(z,{get columns(){return W},get data(){return t(v)},get filterText(){return t(j)},useFilterCache:!0,getFilterContent:o=>[f.productosMap.get(o.ProductoID)?.Nombre,o.SKU,o.Lote].filter(l=>l).join(" ").toLowerCase()});var ae=u(z,2);_e(ae,{id:1,type:"bottom",css:"p-12 min-h-360",title:"Agregar Stock",titleCss:"h2",saveButtonName:"Agregar",saveButtonIcon:"icon-ok",contentOverflow:!0,onSave:()=>{(!t(a).ProductoID||!t(a).Cantidad)&&E.failure("Debe seleccionar un producto y una cantidad."),F(t(a),t(a).Cantidad),Q.hideSideLayer()},children:(o,p)=>{var l=Ce(),_=x(l);{let d=U(()=>f.productos||[]);K(_,{label:"Producto",css:"col-span-24",required:!0,save:"ProductoID",get options(){return t(d)},keyName:"Nombre",keyId:"ID",get saveOn(){return t(a)},set saveOn(D){c(a,D,!0)}})}var S=u(_,2);{var P=d=>{{let D=U(()=>t(G)?.Presentaciones||[]);K(d,{label:"Presentación",css:"col-span-24",save:"PresentacionID",get options(){return t(D)},keyName:"nm",keyId:"id",get saveOn(){return t(a)},set saveOn(se){c(a,se,!0)}})}};V(S,d=>{(t(G)?.Presentaciones?.filter(D=>D.ss)||[]).length>0&&d(P)})}var L=u(S,2);A(L,{label:"SKU",css:"col-span-16",save:"SKU",get saveOn(){return t(a)},set saveOn(d){c(a,d,!0)}});var B=u(L,2);A(B,{label:"Cantidad",required:!0,css:"col-span-8",save:"Cantidad",type:"number",get saveOn(){return t(a)},set saveOn(d){c(a,d,!0)}});var R=u(B,2);A(R,{label:"Lote",css:"col-span-16",save:"Lote",get saveOn(){return t(a)},set saveOn(d){c(a,d,!0)}});var oe=u(R,2);A(oe,{label:"Costo x Unidad",css:"col-span-8",save:"CostoUn",type:"number",get saveOn(){return t(a)},set saveOn(d){c(a,d,!0)}}),w(l),b(o,l)},$$slots:{default:!0}}),b(e,s)},$$slots:{default:!0}}),ce()}ie(["keyup","click"]);export{Ge as component};
