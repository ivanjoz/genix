import{a as y,f as J,g as Q,c as v,d as lt,i as s,b as B,F as at,S as H,t as b,o as st,u as ct,e as C,h as dt}from"./web-B5q02dNy.js";import{S as it,n as ut,o as vt,I as ft,q as O,r as X,a as tt,P as _t,v as mt,L as Y,w as nt,x as pt,t as gt,y as bt,e as kt,z as ht,A as rt}from"./app-BWK4gxn2.js";import{u as St,g as yt}from"./productos-B36PFsTO.js";import{u as wt}from"./sedes-almacenes-D6o03K97.js";import{Q as $t}from"./QTable-BOTD2X_R.js";const Pt="_card_venta_we406_1",xt="_card_venta_nombre_we406_16",Ct="_card_venta_nombre_line_we406_29",It="_card_venta_producto_we406_40",Dt="_card_venta_producto_ctn_we406_44",Mt="_buttons_cantidad_we406_48",Tt="_button_venta_cantidad_we406_57",Ut="_input_cantidad_we406_75",At="_producto_sku_we406_97",I={card_venta:Pt,card_venta_nombre:xt,card_venta_nombre_line:Ct,card_venta_producto:It,card_venta_producto_ctn:Dt,buttons_cantidad:Mt,button_venta_cantidad:Tt,input_cantidad:Ut,producto_sku:At};var Lt=b('<div class="jc-between mb-06 mr-16"><div class=flex><div class="search-c4 mr-16 w14rem"><div><i class=icon-search></i></div><input class=w100 autocomplete=off type=text></div></div><div class="flex jc-between w100"><div class=mr-auto></div></div><div>'),Vt=b('<div class="side-layer1 grow-1 px-12 py-08"><div class="flex ai-center jc-between w100 mb-12"><div class="ff-bold h3 mb-04">DETALLE DE VENTA</div><div class="flex ai-center"><button class="bn1 b-blue">Guardar<i class=icon-floppy></i></button></div></div><div class="w100-10 flex-wrap">'),Nt=b('<div class="box-error-ms mb-08">'),Et=b("<span>"),Ft=b('<button class="bn1 s5 b-red"><i class=icon-trash>'),et=b("<div>"),jt=b('<div class="ml-04 mr-04">|'),Kt=b('<div class="ff-bold c-purple2">'),Bt=b('<div class="ff-bold ml-04 c-purple2">(SKU)'),zt=b('<div class="flex ai-center">'),Gt=b('<div class="flex-wrap z20 p-rel">'),Rt=b('<div class="px-04 py-02"><div><div><div></div></div><div class="w100 grid ai-center"><div><div></div></div><div><input type=number value=""class="ff-mono w100"><div class=ml-04>/</div></div><div class="ff-mono t-r"></div><div class="ff-mono t-r">');const[Z,qt]=y(null);function Zt(){const[n,w]=y([]),[$]=St(),[g]=wt(),[P,W]=y({}),[d,_]=y(""),[f,k]=y(-1),[M,D]=y(-1),[A,T]=y(""),[h,E]=y([]);let L;const F=J(()=>mt(h(),"key")),o=async t=>{let e=[];Y.standard("Obteniendo Registros...");try{e=await yt(t)}catch{Y.remove();return}console.log("productos stock::",e),w(e),nt.setValue("almacen_id",t),Y.remove()};Q(()=>{if(M()==-1&&g()?.Almacenes?.length>0){P();let t=nt.getValueInt("almacen_id")||0;t||(t=g().Almacenes[0].ID),D(t),o(t)}});const[U,S]=y([]),[V,z]=y([]);Q(()=>{const t=pt(n(),"ProductoID");console.log("productos stock map::",n(),t);const e=[];for(let r of $()?.productos||[]){const c=t.get(r.ID)||[];if(c.length===0)continue;const l={producto:r,cant:0,key:`P${r.ID}`,searchText:r.Nombre.toLowerCase()},u=[],p=[];for(let i of c)i.SKU?u.push(i):p.push(i);if(u.length>0){const i={...l,skus:u,key:`K${r.ID}`};for(let a of u)i.cant+=a.Cantidad;e.push(i)}if(p.length>0){let i;r.SbnCantidad>1&&(i={...l,key:`S${r.ID}`},i.isSubUnidad=!0,i.cant=r.SbnCantidad);for(let a of p)l.cant+=a.Cantidad;e.push(l),i&&e.push(i)}}S(e),z(e)});const G="abcdefghijklmnopqrstuvwxyz",j="123456789";let N="";const R=t=>{t===d()||t===N||(console.log("buscando:: ",t),N=t,gt(()=>{const e=t.toLowerCase().split(" "),r=[];for(let c of V())bt(c.searchText,e)&&r.push(c);console.log("filtrados::",r),S(r),_(t),k(-1)},80))},K=(t,e,r)=>{const c=F().get(t.key)?.cantidad||0;if(t.cant-c<e){T(`No hay suficiente stock de "${t.producto.Nombre}" para agregar ${e} unidades.`);return}const u=h().find(a=>a.key===t.key);u?u.cantidad+=e:h().push({key:t.key,cantidad:e,productoID:t.producto.ID,isSubUnidad:t.isSubUnidad||!1});const p=[...h()];E(p);const i=Z();i&&(i.value=""),L&&(L.value=""),_(""),S([...V()]),k(-1)},q=t=>{console.log("recalculando::",t);const e={...P(),total:0,subtotal:0,igv:0};for(let r of t){const l=$().productosMap.get(r.productoID).PrecioFinal*r.cantidad;e.total+=l}e.subtotal=Math.floor(e.total/1.18),e.igv=e.total-e.subtotal,W(e)};return Q(st(()=>h(),()=>{q(h())})),v(_t,{title:"Ventas",class:"flex",get children(){return[(()=>{var t=Lt(),e=t.firstChild,r=e.firstChild,c=r.firstChild,l=c.nextSibling,u=e.nextSibling;u.firstChild;var p=u.nextSibling;t.style.setProperty("width","48%"),s(e,v(it,{css:"w16rem s6 mb-02 mr-12",label:"",keys:"ID.Nombre",get options(){return g()?.Almacenes||[]},placeholder:" ALMACÉN",get selected(){return M()},onChange:a=>{if(a){o(a.ID);return}}}),r),l.$$keydown=a=>{if(a.stopPropagation(),A()?.length>0&&T(""),console.log(a.key),a.key==="ArrowUp"){const m=f()-1;if(m<-1)return;k(m)}else if(a.key==="ArrowDown")k(f()+1);else if(a.key==="Enter"&&f()>=0){const m=Z(),x=parseInt(m.value||"0")||1,ot=U()[f()];if(ot.skus?.length>0){T("Debe seleccionar 1 SKU.");return}K(ot,x)}else{const m=a.key.toLocaleLowerCase();if(f()>=0&&(j.includes(m)||a.key==="Backspace")){const x=Z();console.log("key backspace:: ",x.value),x&&(a.key==="Backspace"?x.value&&(x.value="",a.preventDefault()):(x.value+=m,a.preventDefault()))}else(G.includes(m)||j.includes(m))&&R(N+a.key)}},l.addEventListener("keypress",()=>!1),l.$$keyup=a=>{a.stopPropagation();const m=(a.target.value||"").toLowerCase().trim();R(m)};var i=L;return typeof i=="function"?ct(i,l):L=l,s(u,v(ut,{label:"Buscar SKU"}),null),p.style.setProperty("height","calc(100% - 12px - 4.2rem)"),p.style.setProperty("position","relative"),s(p,v(vt,{get data(){return U()},render:(a,m)=>{console.log("card rerender:: ",m,a);const x=()=>m===f();return v(Ot,{idx:m,get isSelected(){return x()},get ventasProductosMap(){return F()},productoStock:a,agregarProductoVenta:K,setProductoSelected:k,get filterText(){return d()},onmouseover:()=>{f()>=0&&k(-1)}})}})),B(()=>t.classList.toggle("column",!![2,3].includes(kt()))),t})(),(()=>{var t=Vt(),e=t.firstChild,r=e.nextSibling;return t.style.setProperty("width","calc(var(--page-width) * 0.52)"),s(t,(()=>{var c=J(()=>!!A());return()=>c()&&(()=>{var l=Nt();return s(l,A),l})()})(),e),s(r,v(ft,{label:"Cliente",css:"w-06x",get saveOn(){return P()},save:"clienteID"}),null),s(r,v(O,{label:"Código",css:"w-05x"}),null),s(r,v(O,{label:"Sub Total",css:"ff-mono w-045x",getContent:()=>X(P().subtotal)}),null),s(r,v(O,{label:"IGV",css:"ff-mono w-04x",getContent:()=>X(P().igv)}),null),s(r,v(O,{label:"Total",css:"ff-mono w-045x",get content(){return P().total},getContent:()=>X(P().total)}),null),s(t,v($t,{get data(){return h()},css:"w100 mt-12",tableCss:"w-page-t w100",maxHeight:"calc(100vh - 12rem - 12px)",columns:[{header:"Nº",getValue:(c,l)=>String(l+1)},{header:"Producto",render:c=>{const l=$().productosMap.get(c.productoID);let u=l?.Nombre||"";return c.isSubUnidad&&(u=`${l.SbnUnidad} de ${u}`),u}},{header:"SKU",render:c=>c.sku||""},{header:"Cantidad",render:c=>tt(c.cantidad)},{header:"Monto",css:"ff-mono t-r",render:c=>{const u=$().productosMap.get(c.productoID).PrecioFinal*c.cantidad;return(()=>{var p=Et();return s(p,()=>tt(u/100,2)),p})()}},{header:"...",headerStyle:{width:"2rem"},cellStyle:{padding:"0 4px"},render:c=>(()=>{var l=Ft();return l.$$click=u=>{u.stopPropagation();const p=h().filter(i=>i.key!==c.key);E(p)},l})()}]}),null),t})()]}})}function Ht(){const n=[2,3,4,5,6,8,10,12];return(()=>{var w=et();return s(w,v(at,{each:n,children:$=>(()=>{var g=et();return s(g,$),B(()=>C(g,`flex-center ff-bold ${I.button_venta_cantidad}`)),g})()})),B(()=>C(w,["flex p-rel ai-end h100",I.buttons_cantidad].join(" "))),w})()}const Ot=n=>{let w;Q(st(()=>n.isSelected,()=>{n.isSelected&&qt(w)}));const $=()=>{const d=ht(n.productoStock.producto.Nombre,n.filterText);return n.productoStock.isSubUnidad||n.productoStock.skus?.length>0?(()=>{var _=zt();return s(_,d,null),s(_,v(H,{get when(){return n.productoStock.isSubUnidad},get children(){return[jt(),(()=>{var f=Kt();return s(f,()=>n.productoStock.producto.SbnUnidad),f})()]}}),null),s(_,v(H,{get when(){return!n.productoStock.isSubUnidad},get children(){return Bt()}}),null),_})():d},g=()=>n.productoStock.skus?.length>0,P=J(()=>{const d=n.productoStock.key;let _=n.ventasProductosMap.get(d)?.cantidad||0;if(d[0]==="P"){const f=`S${d.slice(1)}`,k=n.ventasProductosMap.get(f)?.cantidad||0;if(k>0){const M=n.productoStock.producto;_=_+Math.ceil(k/M.SbnCantidad)}}return n.productoStock.cant-_}),W=J(()=>{let d=n.productoStock.skus||[];return d.length>4&&(d=d.slice(0,4)),d});return(()=>{var d=Rt(),_=d.firstChild,f=_.firstChild,k=f.firstChild,M=f.nextSibling,D=M.firstChild,A=D.firstChild,T=D.nextSibling,h=T.firstChild,E=T.nextSibling,L=E.nextSibling;d.$$mouseover=o=>{o.stopPropagation(),n.onmouseover()},_.$$click=()=>{n.setProductoSelected(n.idx)},s(f,$,null),M.style.setProperty("grid-template-columns","1fr 3.8rem 2.8rem 5rem"),s(A,$),s(D,v(H,{get when(){return g()},get children(){var o=Gt();return o.style.setProperty("margin","0 -3px"),s(o,v(at,{get each(){return W()},children:U=>(()=>{var S=et();return s(S,()=>U.SKU),B(()=>C(S,`h5 ${I.producto_sku}`)),S})()})),o}}),null),s(D,v(H,{get when(){return!g()},get children(){return v(Ht,{})}}),null);var F=w;return typeof F=="function"?ct(F,h):w=h,s(E,P),s(L,()=>tt(n.productoStock.producto.PrecioFinal/100,2)),B(o=>{var U=!!n.isSelected,S=!!g(),V=n.idx===0?"8px":void 0,z=rt("flex p-rel jc-between",I.card_venta),G=I.card_venta_nombre,j=I.card_venta_nombre_line,N=`h100 ${I.card_venta_producto_ctn}`,R={"flex ai-center":!g()},K=`${I.card_venta_producto}`,q=rt("p-rel flex ai-center",I.input_cantidad);return U!==o.e&&d.classList.toggle("sld",o.e=U),S!==o.t&&d.classList.toggle("sku",o.t=S),V!==o.a&&((o.a=V)!=null?d.style.setProperty("margin-top",V):d.style.removeProperty("margin-top")),z!==o.o&&C(_,o.o=z),G!==o.i&&C(f,o.i=G),j!==o.n&&C(k,o.n=j),N!==o.s&&C(D,o.s=N),o.h=dt(D,R,o.h),K!==o.r&&C(A,o.r=K),q!==o.d&&C(T,o.d=q),o},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0}),d})()};lt(["keyup","keydown","click","mouseover"]);export{Zt as default};
