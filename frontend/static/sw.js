var q=e=>{if(!Array.isArray(e)||e.length!==2)return e;let[t,n]=e;if(!Array.isArray(t))return e;let o={};for(let s of t){if(!Array.isArray(s))continue;let r=s[0],u={},c=-1;for(let h=1;h<s.length;h+=2){let i=s[h],d=s[h+1];u[i]=d,i>c&&(c=i)}o[r]={fields:u,maxIndex:c}}let l=null,f=s=>{if(!Array.isArray(s)||s.length===0)return s;let r=s[0];if(r===1){if(s.length<2)return s;let u=s[1];if(!Array.isArray(u))return s;let c=u[0],h=new Set;for(let i=1;i<u.length;i++)h.add(u[i]);return l=c,a(c,s.slice(2),h)}if(r===0){if(l===null)return s;let u=new Set,c=1;if(Array.isArray(s[1])){let h=s[1],i=!1;if(h.length>0){let d=h[0];typeof d=="number"&&d!==0&&d!==1&&d!==2&&d!==3?i=!0:i=typeof d=="number"&&d!==0&&d!==1&&d!==2&&d!==3}if(i){for(let d of h)typeof d=="number"&&u.add(d);c=2}}return a(l,s.slice(c),u)}if(r===2){let u=[];for(let c=1;c<s.length;c++)u.push(f(s[c]));return u}if(r===3){let u={};for(let c=1;c<s.length;c+=2)if(c+1<s.length){let h=String(s[c]);u[h]=f(s[c+1])}return u}return s.map(f)},a=(s,r,u)=>{let c=o[s];if(!c)return r;let{fields:h,maxIndex:i}=c,d={},p=0;for(let _=0;_<=i;_++){if(u.has(_))continue;if(p>=r.length)break;let y=h[_];y&&(d[y]=f(r[p])),p++}return d};return f(n)};var O=(e,t)=>{if(Array.isArray(e))return e.map(n=>O(n,t));if(typeof e!="object"||!e||!e._)return e;for(let[n,o]of Object.entries(e))if(t.has(n)){let l=t.get(n);if(l===n)continue;e[l]=o,delete e[n]}for(let n=0;n<e._.length;n+=2){let o=t.get(e._[n]);e[o]=O(e._[n+1],t)}return delete e._,e};var W="precache-v2",H="assets-v2",K="static-v2",x="app",b=new Map,Q=[],X=e=>{let t=e.indexOf("?");t!==-1&&(e=e.substring(0,t));let n=e.indexOf("@");n!==-1&&(e=e.substring(0,n)),e=e.substring(e.indexOf("/",8));let o=e.lastIndexOf(".");return e==="/"||(o===-1&&e[2])==="/"?[e,"*"]:[e,e.substring(o+1)]};self.addEventListener("install",e=>{e.waitUntil(caches.open(W).then(t=>t.addAll(Q)).then(()=>self.skipWaiting()))});self.addEventListener("activate",e=>{let t=[W,H,K,x];e.waitUntil(self.clients.claim())});var Y=e=>{let t=e.indexOf('name="build-version"');if(t===-1)return null;let n=e.indexOf('"',t+28);return e.substring(n+1,n+7)},Z=e=>{let t=Math.floor(Date.now()/1e3),n=parseInt(e.toLowerCase(),36)*10,o=t-n,l=Math.floor(o/60/60),f=Math.floor((o-l*60*60)/60),a=`${l} hora${l===1?"":"s"}`,s=`${a} ${f} min`;return l===0&&(s=`${f} min`),l>12&&(s=`m\xE1s de ${a}`),s},U={build:"",hasUpdated:!1};b.set(99,async e=>({...e,response:"pong"}));self._isLocal=self.origin.includes("localhost")||self.origin.includes("127.0.0.1");var L=0;b.set(7,async e=>{let t=Math.floor(Date.now()/1e3);if(L&&t-L<30)return console.log("Saltando revisi\xF3n de actualizaci\xF3n."),{};let n=e.version;if(!n)return console.log("No se envi\xF3 la version (build) a comparar."),{};let o=await ee(n);return L=t,{versionHasUpdated:o}});var ee=async e=>{U.build=e;let t=new Headers;t.append("pragma","no-cache"),t.append("cache-control","no-cache");try{let o=await(await fetch(self.location.origin+"/app-version",{method:"GET",headers:t})).text(),l=Y(o)||"";if(U.build=l,console.log("build code compare fetch:: ",e," | ",l),e!==l)return await caches.delete(H),Z(l)}catch(n){console.warn("Error al obtener la versi\xF3n nueva (HTML)::",n)}return""},P=new Map,F=new Map,V=new Map,z=(e,t)=>{let n=V.get(e);n?n(t):console.log("No se encontr\xF3 el handler para el client:",e,"|",t)};self.addEventListener("fetch",e=>{let t=e.request,n=new URL(e.request.url);if(n.pathname.startsWith("/store/")||t.headers.get("X-App-Scope")==="store")return;if(n.pathname==="/_sw_"){e.respondWith((async()=>{let i=parseInt(n.searchParams.get("accion")||"0"),d=parseInt(n.searchParams.get("req")||"0"),p=n.searchParams.get("env")||"main";P.has(e.clientId)||P.set(e.clientId,P.size+1);let _=P.get(e.clientId)||0,y=d*1e3+_,g=F.get(y)||0;if(g&&Date.now()-g<1e3){let $=Date.now()-g;return console.log("El id ",d," est\xE1 duplicado. | Client:",e.clientId,"| Hace:",$,"ms"),new Response(JSON.stringify({Error:"ReqID Duplicado."}),{headers:{"Content-Type":"application/json"}})}F.set(d,Date.now());let m=await self.clients.get(e.clientId);if(!m){console.warn(`No se encontr\xF3 el client con ID ${e.clientId}`);let $={error:`No se encontr\xF3 el client con ID ${e.clientId}`};return new Response(JSON.stringify($),{headers:{"Content-Type":"application/json"}})}V.set(_,$=>{m.postMessage($)});let v=b.get(i);if(!v){console.warn(`No se encontr\xF3 el handler para la acci\xF3n ${i}`);let $={error:`No se encontr\xF3 el handler para la acci\xF3n ${i}`};return new Response(JSON.stringify($),{headers:{"Content-Type":"application/json"}})}let C=await e.request.clone().json();C.__enviroment__=p,C.__client__=_;let T={...await v(C),__response__:i,__req__:d},N="";return i===3&&(N=[C.route,C.cacheMode,d].join(" | ")),m.postMessage(T),console.log(`Respondiendo Fetch (${N}):`,D(T)),new Response(JSON.stringify({ok:1}),{headers:{"Content-Type":"application/json"}})})());return}if(self._isLocal)return;if(n.searchParams.has("__cache__")){let i=n.searchParams.get("__cache__")||"",[d,p,_]=i.split("."),y=parseInt(d),g=parseInt(p);if(isNaN(y)||isNaN(g))return console.warn(`Invalid __cache__ parameter format: ${i}. Bypassing cache.`),fetch(e.request);n.searchParams.delete("__cache__");let m=n.toString();console.log("buscando cach\xE9:",m),e.respondWith((async()=>{let v=await caches.open(`cache_req_${_}`),w=await v.match(m),C=Math.floor(Date.now()/1e3);if(w){let k=parseInt(w.headers.get("x-cache-timestamp")),T=parseInt(w.headers.get("x-cache-version"));if(k&&T&&C-k<y*60&&T===g)return console.log(`Serving from cache: ${m}`),w;console.log(`Cache stale or version mismatch for ${m}. Fetching new.`)}try{let k=await fetch(e.request);if(k.status===200){let T=k.clone(),N=new Headers(T.headers);N.set("x-cache-timestamp",String(C)),N.set("x-cache-version",String(g));let $=new Response(await T.blob(),{status:T.status,statusText:T.statusText,headers:N});await v.put(m,$),console.log(`Fetched and cached: ${m}`)}else console.log("La consulta fall\xF3::",k.status);return k}catch(k){if(console.error(`Fetch failed for ${m}:`,k),w)return console.log(`Network failed, serving stale cache for ${m}`),w;throw k}})())}let o=t.headers.get("Content-Type");if(console.log("event URL:: ",t.url,"|",o),!t.url.startsWith(self.location.origin))return;let[l,f]=X(t.url);if(l==="/app-version")return;let a=new URL(t.url),s=a.origin===self.location.origin,r=t.mode==="navigate",u=!a.pathname.includes(".")||a.pathname==="/";f==="*"&&console.log("Re-routing Service Worker:: ",l);let c=["js","css","html","*","ts","mjs","tsx"].includes(f)?H:K,h="/";if(s&&r&&u){e.respondWith(caches.open(c).then(i=>i.match(h).then(d=>d&&!navigator.onLine?(console.log(`[Service Worker] Serving cached HTML for ${t.url} from ${h}`),d):(console.log(`[Service Worker] HTML not in cache, fetching from network: ${t.url}`),fetch(t).then(p=>{let _=p.headers.get("Content-Type");return p.ok&&_&&_.includes("text/html")&&(console.log(`[Service Worker] Caching new HTML response from ${t.url} as ${h}`),i.put(h,p.clone())),p}).catch(p=>d||(console.error(`[Service Worker] Network failed for HTML navigation: ${t.url}`,p),new Response("<h1>Offline</h1><p>You appear to be offline and this content is not cached.</p>",{headers:{"Content-Type":"text/html"}})))))));return}e.respondWith(caches.open("cache_").then(i=>i.match(t).then(d=>{if(d)if((d.headers.get("content-type")||"").includes("/html"))console.log("Es HTML!!",f);else return console.log("[Service Worker] Serving from cache:",t.url),d;return fetch(t).then(p=>{if(!p||p.status!==200||p.type!=="basic")return p;let _=t.headers.get("Content-Type");console.log("Guardando en cach\xE9: ",c," | "+t.url," | ",_);let y=p.clone();return console.log("[Service Worker] Caching new asset:",t.url),i.put(t,y),p}).catch(p=>(console.error("[Service Worker] Fetch failed:",t.url,p),new Response("Network error occurred.",{status:503,statusText:"Service Unavailable"})))})))});var M=new Map,J=async(e,t)=>{let n=t?t+"_"+x:x,l=await(await caches.open(n)).match(e),f=M.get(n);return!l&&f&&f.delete(e),l},I=async(e,t)=>{let n=t?t+"_"+x:x;M.has(n)||M.set(n,new Map);let o=M.get(n);if(o?.has(e)){if(await caches.has(n))return o.get(e);M.set(n,new Map)}let l=await caches.open(n),f=Date.now(),a=await l.match(e);if(a){let s=await a.json();if(s.__keys__){let r=new Map(s.__keys__),u=new Map([...r.entries()].map(c=>[c[1],c[0]]));s=O(s.content,u)}return console.log(`Cache response "${e}" in ${Date.now()-f}ms (v2)`),s}},S=async(e,t,n)=>{let o=n?n+"_"+x:x;M.has(o)||M.set(o,new Map);let l=await caches.open(o),f=M.get(o);if(!t){f?.delete(e),await l.delete(e);return}f?.set(e,t);let a=Date.now();typeof t!="string"&&(t=JSON.stringify(t));let s=new Response(t,{headers:{"Content-Type":"application/json","Content-Length":String(t.length)}});await l.put(e,s),console.log(`Cache put "${e}" in ${Date.now()-a}ms (v2)`)},D=e=>{let t={};for(let n in e){let o=e[n];typeof o=="number"||typeof o=="string"?t[n]=o:Array.isArray(o)?t[n]=`[${o.length}]`:o&&typeof o=="object"&&(t[n]=`{${Object.keys(o).join(", ")}}`)}return t};var te=async(e,t)=>{let n=e.headers.get("Content-Type");if(e.status&&t.status&&(t.status.code=e.status,t.status.message=e.statusText),e.status===200){let o=e.body?.getReader(),l=new ReadableStream({start(s){return r();function r(){return o.read().then(({done:u,value:c})=>u?(s.close(),Promise.resolve()):(z(t.__client__,{__response__:5,bytes:c.length}),s.enqueue(c),r()))}}}),a=await new Response(l).text();return t&&(t.contentLength=a.length),Promise.resolve(JSON.parse(a))}else if(e.status===401)console.warn("Error 401, la sesi\xF3n ha expirado.");else if(e.status!==200)return console.log(e),!n||n.indexOf("/json")===-1?(console.log("Parseando como texto"),e.text()):(console.log("parseando como JSON"),e.json())},E=(e,t)=>{let n={};for(let[o,l]of Object.entries(e)){if(l&&!Array.isArray(l))continue;let f=0;for(let a of l||[]){let s=a.updated||a.upd||0;t?(f===0||s<f)&&(f=s):s>f&&(f=s)}n[o]=f}return n},A=(e,t,n)=>{let o=e.includes("?")?"&":"?";return typeof n=="string"&&(n=n.replace("?","&")),e+`${o}${t}=${n}`},j=!1,G=new Set;b.set(11,async()=>(j=!0,G=new Set,setTimeout(()=>{j=!1},8e3),{ok:1}));b.set(3,async e=>await re(e));var R=e=>{let t=[e.route,e.partition?.value||"0"].join("_"),n=[e.__enviroment__||"main",e.module||"?"].join("_");return[t,n]};b.set(12,async e=>{let[t,n]=R(e),o=await I(t+"_updated",n);return console.log("lastSync obtenido (1):",e,e.route,t,o),{updatedStatus:o?.updatedStatus||{},updated:o?.fetchTime||0}});var ne=(e,t)=>e.keysIDs&&Object.hasOwn(e.keysIDs,t)?e.keysIDs[t]:e.keyID||"id",oe=(e,t)=>{if(typeof t=="string")return e[t]||e.ID||0;if(Array.isArray(t)){let n=[];for(let o of t)if(e[o])n.push(e[o]);else return 0;return n.join("_")}else return 0},B=async(e,t,n,o)=>{Array.isArray(n)&&(n={_default:n});let l=E(n),f=E(n,!0),a=!1;for(let[c,h]of Object.entries(l)){if(!h)continue;let i=t.updatedStatus[c];h!==i&&(t.updatedStatus[c]=h,a=!0),f[c]<i&&console.warn(`Cache Error: En "${e.route}" [${c}] se est\xE1n obteniendo registros con [updated] menor que el cach\xE9 (${(n[c]||[]).length} recibidos)`)}console.log("Fetch cache ha cambiado?:",a,"|",e.route,"|",l);let[s,r]=R(e),u=s+"_updated";if(!a&&e.cacheMode!=="updateOnly")n=await I(s,r);else if(a){let c=await I(s,r);console.log("cache obtenido:",s,r,e),self._isLocal&&console.log("prevResponse (old)",e.route,e.cacheMode,{...c});let h={};for(let[i,d]of Object.entries(n)){if((d||[]).length===0)continue;let p=ne(e,i),_=0;h[String(p)]=(h[String(p)]||0)+d.length;let y=w=>{let C=oe(w,p);return C||_++,C},g=c[i]||[];if(!Array.isArray(g))continue;let m=new Map;for(let w of g)m.set(y(w),w);for(let w of d)m.set(y(w),w);_>0&&console.warn(`Cache Error: En "${e.route}" (${i}) hay ${_} registros sin la key: ${p}`),console.log("Cache usedKeysCount",h);let v=[];for(let w of m.values())v.push(w);c[i]=v}self._isLocal&&console.log("prevResponse (new)",e.route,e.cacheMode,{...c}),S(s,c,r),n=c}else n=null;return t.fetchTime=o,S(u,t,r),n},se=new Set;b.set(21,async e=>{let t=(e.__req__||0)*1e3+e.__client__;se.add(t)});var re=async e=>{console.log("Obteniendo fetch service worker:",e.route,"|",e.cacheMode,"|",e.__req__,"|",e.__version__);let[t,n]=R(e),o=t+"_updated",l=r=>{if(!r||Object.keys(r).length===0)return["sin registros"];let u=[];for(let c of Object.keys(r))u.push(`${c}=${(r[c]||[]).length}`);return u},f={fetchTime:0,updatedStatus:{},__version__:e.__version__},a=await I(o,n)||f;if(a.fetchTime&&a.__version__!==e.__version__)console.log(`Linmpiando cach\xE9, difererente versi\xF3n ${e.__version__} > ${a.__version__}. Route ${e.route}`),a=f,await S(o,a,n),await S(t,null,n);else{let r=await J(t,n);a.fetchTime&&!r?(await S(o,f,n),a=f):r&&!a.fetchTime&&await S(t,null,n)}if(e.cacheMode==="offline"){let r=await I(t,n);if(r&&r.__version__===e.__version__){let u=E(r);for(let[c,h]of Object.entries(u)){let i=!1;a.updatedStatus[c]!==h&&(console.log("El updatedStatus difiere:",e.route,"|",c,"|",a.updatedStatus[c]," vs ",h),a.updatedStatus[c]=h,i=!0),i&&S(o,a,n)}}return console.log("Enviando fetch response (offline):",e.route),console.log(`${e.route}: Retornando registros "${e.cacheMode||"normal"}". ${l(r).join(" | ")}`),{content:r?._default?r._default:r}}let s=Math.floor(Date.now()/1e3);e.status={code:200,message:""};try{let r=e.routeParsed||e.route;if(e.partition&&e.partition.value){let d=e.partition.param||e.partition.key;r=A(r,d,e.partition.value)}let u=a&&a.updatedStatus&&a.fetchTime;console.log("hasCache",e.route,a);let c=e.fields||[];for(let d of c)a.updatedStatus[d]||0||(r=A(r,d,0));if(u){if(a.updatedStatus._default)r=A(r,"updated",a.updatedStatus._default);else{let g=0;for(let[m,v]of Object.entries(a.updatedStatus))(g===0||v<g)&&(g=v),!(c.length>0&&!c.includes(m))&&(r=A(r,m,v));r=A(r,"updated",g)}let d=e.cacheSyncTime||e.useCache?.min||0,p=a.fetchTime+d*60,_=p-s,y=e.cacheMode==="refresh";a.forceNetwork?(console.log("Forzando fetch por flag forceNetwork en ILastSync:",e.route),y=!0,a.forceNetwork=!1,await S(o,a,n)):j&&!G.has(t)?(console.log("Forzando fetch por flag global:",e.route),y=!0):_<=0&&(console.log("Preparando fetch: ",e.route," | Last: ",a.fetchTime,"| Remainig:",_),y=!0);for(let g of e.fields||[])a.updatedStatus[g]||0||(y=!0);if(!y){let g=p-s;if(console.log(`Obviando sync fech "${t}". Quedan ${g}s`),e.cacheMode==="updateOnly")return console.log(e.route,"Retornando null por 'updated only'"),{content:null};{let m=await I(t,n);return console.log(`${e.route}: Retornando registros "${e.cacheMode||"normal"}`,D(m)),{content:m?._default?m._default:m}}}}console.log(`Realizando fetch (${r})...`);let h=await self.fetch(r,{headers:e.headers});if(h.status&&h.status!==200)return{error:await h.text()};let i=await te(h,e)||{};if(console.log("response pre-unmarshall",i),i=q(i),console.log("response post-unmarshall",i),Array.isArray(i.response)&&typeof i.message=="string"&&(i=i.response),Array.isArray(i)&&(i={_default:i}),i.__version__=e.__version__,console.log(`Fetch response recibida! (${r}) | Has-cach\xE9: ${u}`),u)console.log("prevResponse (hasCache)",e.route,e.cacheMode,{...i}),i=await B(e,a,i,s);else{let d=E(i);Object.assign(a,{fetchTime:s,updatedStatus:d}),S(o,a,n),console.log("prevResponse (recent)",e.route,e.cacheMode,{...i}),S(t,i,n)}return console.log(`${e.route}: Retornando registros "${e.cacheMode||"normal"}". ${l(i).join(" | ")}`),{content:i}}catch(r){return console.log("Fetch Error::",r),{error:r}}};b.set(13,async e=>{let[t,n]=R(e.args)+"_updated",o=await I(t,n)||{fetchTime:0,updatedStatus:{}},l=Math.floor(Date.now()/1e3)-5;e.args.__enviroment__=e.__enviroment__,console.log("Guardando external fech response en cach\xE9:",e.args.route),B(e.args,o,e.response,l)});b.set(14,async e=>{let[t,n]=R(e),o=t+"_updated",l=await I(o,n)||{fetchTime:0,updatedStatus:{}};return l.forceNetwork=!0,await S(o,l,n),console.log(`ForceNetwork set to true for key: ${o}`),{ok:1}});b.set(15,async e=>{let t={route:e.route,module:e.module,partition:{value:e.partValue}},[n,o]=R(t),l=await I(n,o);if(!l)return[];let f=l[e.propInResponse||"_default"];if(!f)return[];if(e.filter){let a=e.filter.split(",").filter(r=>r).map(r=>{let u=r.split("=");return isNaN(u[1])?u.push(0):u.push(parseInt(u[1])),u});console.log("keyValues filters:",a);let s=[];for(let r of f)for(let u of a){let c=r[u[0]];(c===u[1]||c===u[2])&&s.push(r)}return s}else return l});b.set(22,async e=>{console.log("obteniendo cantidad de registros obtenidos");let t=await caches.keys();console.log("cache stores::",t,"| Env:",e.__enviroment__);let n=[];for(let o of t){if(!o.includes("_"))continue;let[l,f]=o.split("_");l===e.__enviroment__&&n.push({name:o,module:f,size:0})}return await Promise.all(n.map(o=>new Promise((l,f)=>{let a;caches.open(o.name).then(s=>(a=s,a.keys())).then(s=>Promise.all(s.map(async r=>{try{let u=await a.match(r);if(u){let c=u.headers.get("Content-Length")||u.headers.get("content-length");o.size||(o.size=0),o.size+=parseInt(c||"0",10)}else console.warn(`Service Worker: No matching response found for request in cache '${o.name}':`,r.url)}catch(u){console.error(`Service Worker: Error matching request or getting size for ${r.url}:`,u)}}))).then(()=>{l(0)}).catch(s=>{console.log("Error al obtener informacion del cach\xE9:",s),f(s)})}))),console.log("cacheStats",n),{cacheStats:n}});b.set(23,async e=>(console.log(`Eliminando cach\xE9 "${e.cacheName}" (Enviroment ${e.__enviroment__})...`),await caches.delete(e.cacheName),console.log(`Cach\xE9 "${e.cacheName}" eliminado! (Enviroment ${e.__enviroment__})...`),{ok:1}));b.set(26,async e=>{console.log("Eliminando cach\xE9...");let t=await caches.keys();for(let n of t)n.startsWith(e.__enviroment__)&&(console.log(`Eliminando cach\xE9 por ambiente "${e.__enviroment__}": ${n}`),await caches.delete(n));return console.log("Cach\xE9 eliminado."),{ok:1}});b.set(24,async e=>{let t=[e.__enviroment__||"main",e.module||"?"].join("_");console.log("Setting ForceNerwork for routes: ",e.routes);let o=await(await caches.open(t+"_"+x)).keys(),l=new Set;for(let f of o){let a=f.url.split("/")[3];if(a){console.log("buscando request::",a);for(let s of e.routes)if(a.startsWith(s)&&a.endsWith("_updated")){let r=await I(a,t);r.forceNetwork=!0,await S(a,r,t),l.add(s);break}}}return console.log(`ForceNetwork = true for routes: ${[...l].join(", ")} | In ${o.length}`),{ok:1}});
//# sourceMappingURL=sw.js.map
