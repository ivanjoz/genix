import{a as U,j as Z,k as ie,c as v,d as je,g as m,b as f,i as a,e as ee,r as te,F as ye,S as ce,t as x,l as we,u as Pe,f as V,m as Fe}from"./web-BZ6LonWj.js";import{S as Be,C as ze,P as Ge,d as He,m as Re}from"./app-B5wVexcE.js";import{j as qe,I as Oe,k as le,l as ve,b as pe,n as Qe,L as $e,o as he,p as Je,t as We,q as Xe,r as xe}from"./Input-Cf7HKpQs.js";import{u as Ye,g as Ze}from"./productos-CLBJZEeQ.js";import{u as et}from"./sedes-almacenes-CJUuScrB.js";import{Q as tt}from"./QTable-DpMhOfGM.js";const nt="_card_venta_we406_1",ot="_card_venta_nombre_we406_16",rt="_card_venta_nombre_line_we406_29",at="_card_venta_producto_we406_40",st="_card_venta_producto_ctn_we406_44",ct="_buttons_cantidad_we406_48",lt="_button_venta_cantidad_we406_57",it="_input_cantidad_we406_75",dt="_producto_sku_we406_97",A={card_venta:nt,card_venta_nombre:ot,card_venta_nombre_line:rt,card_venta_producto:at,card_venta_producto_ctn:st,buttons_cantidad:ct,button_venta_cantidad:lt,input_cantidad:it,producto_sku:dt};var ut=x('<div class="jc-between mb-06 mr-16"><div class=flex><!$><!/><div class="search-c4 mr-16 w14rem"><div><i class=icon-search></i></div><input class=w100 autocomplete=off type=text></div></div><div class="flex jc-between w100"><div class=mr-auto></div><!$><!/></div><div>'),_t=x('<div class="side-layer1 grow-1 px-12 py-08"><!$><!/><div class="flex ai-center jc-between w100 mb-12"><div class="ff-bold h3 mb-04">DETALLE DE VENTA</div><div class="flex ai-center"><button class="bn1 b-blue">Guardar<i class=icon-floppy></i></button></div></div><div class="w100-10 flex-wrap"><!$><!/><!$><!/><!$><!/><!$><!/><!$><!/></div><!$><!/>'),gt=x('<div class="box-error-ms mb-08">'),ft=x("<div><!$><!/> <!$><!/>"),vt=x("<span class=ml-04>(<!$><!/>)"),$t=x("<span>"),bt=x('<button class="bn1 s5 b-red"><i class=icon-trash>'),me=x("<div>"),pt=x('<div class="ml-04 mr-04">|'),mt=x('<div class="ff-bold c-purple2">'),St=x('<div class="ff-bold ml-04 c-purple2">(SKU)'),kt=x('<div class="flex ai-center"><!$><!/><!$><!/><!$><!/>'),ht=x('<div class="flex-wrap z20 p-rel">'),xt=x('<div class="px-04 py-02"><div><div><div></div><!$><!/></div><div class="w100 grid ai-center"><div><div></div><!$><!/><!$><!/></div><div><input type=number value=""class="ff-mono w100"><div class=ml-04>/</div></div><div class="ff-mono t-r"></div><div class="ff-mono t-r">');const[be,yt]=U(null);function Vt(){const[r,F]=U([]),[P]=Ye(),[C]=et(),[k,O]=U({}),[c,d]=U(""),[u,S]=U(-1),[L,z]=U(-1),[N,M]=U(""),[$,E]=U([]);let K;const j=Z(()=>Qe($(),"key")),ne=async e=>{let t=[];$e.standard("Obteniendo Registros...");try{t=await Ze(e)}catch{$e.remove();return}console.log("productos stock::",t),F(t),he.setValue("almacen_id",e),$e.remove()};ie(()=>{if(L()==-1&&C()?.Almacenes?.length>0){k();let e=he.getValueInt("almacen_id")||0;e||(e=C().Almacenes[0].ID),z(e),ne(e)}});const[oe,Q]=U([]),[re,J]=U([]);ie(()=>{const e=Je(r(),"ProductoID");console.log("productos stock map::",r(),e);const t=[];for(let n of P()?.productos||[]){const b=e.get(n.ID)||[];if(b.length===0)continue;const h={producto:n,cant:0,key:`P${n.ID}`,searchText:n.Nombre.toLowerCase()},i=[],w=[];for(let s of b)s.SKU?i.push(s):w.push(s);if(i.length>0){const s={...h,skus:i,key:`K${n.ID}`};for(let _ of i)s.cant+=_.Cantidad;t.push(s)}if(w.length>0){let s;n.SbnCantidad>1&&(s={...h,key:`S${n.ID}`},s.isSubUnidad=!0,s.cant=n.SbnCantidad);for(let _ of w)h.cant+=_.Cantidad;t.push(h),s&&t.push(s)}}console.log("productos parsed::",t),Q(t),J(t)});const ae="abcdefghijklmnopqrstuvwxyz",W="123456789";let X="";const Y=e=>{e===c()||e===X||(console.log("buscando:: ",e),X=e,We(()=>{const t=e.toLowerCase().split(" "),n=[];for(let b of re())Xe(b.searchText,t)&&n.push(b);console.log("filtrados::",n),Q(n),d(e),S(-1)},80))},o=(e,t,n)=>{const b=j().get(e.key)?.cantidad||0;if(e.cant-b<t){M(`No hay suficiente stock de "${e.producto.Nombre}" para agregar ${t} unidades.`);return}console.log("producto venta::",e);const i=$().find(_=>_.key===e.key);if(i){if(i.cantidad+=t,n){const _=i.skus.get(n);if(_){const G=e.skus.find(H=>H.SKU===n)?.Cantidad||0;if(_>=G){M(`El SKU ${n} del producto "${e.producto.Nombre}" sólo posee ${G} unidad(es).`);return}i.skus.set(n,_+1)}else i.skus.set(n,1)}}else $().push({key:e.key,cantidad:t,productoID:e.producto.ID,skus:new Map(n?[[n,1]]:[]),isSubUnidad:e.isSubUnidad||!1});const w=[...$()];console.log("venta productos::",w),E(w);const s=be();s&&(s.value=""),K&&(K.value=""),d(""),Q([...re()]),S(-1)},B=e=>{console.log("recalculando::",e);const t={...k(),total:0,subtotal:0,igv:0};for(let n of e){const h=P().productosMap.get(n.productoID).PrecioFinal*n.cantidad;t.total+=h}t.subtotal=Math.floor(t.total/1.18),t.igv=t.total-t.subtotal,O(t)};return ie(we(()=>$(),()=>{B($())})),v(Ge,{title:"Ventas",class:"flex",get children(){return[(()=>{var e=m(ut),t=e.firstChild,n=t.firstChild,[b,h]=f(n.nextSibling),i=b.nextSibling,w=i.firstChild,s=w.nextSibling,_=t.nextSibling,G=_.firstChild,H=G.nextSibling,[de,ue]=f(H.nextSibling),R=_.nextSibling;e.style.setProperty("width","48%"),a(t,v(Be,{css:"w16rem s6 mb-02 mr-12",label:"",keys:"ID.Nombre",get options(){return C()?.Almacenes||[]},placeholder:" ALMACÉN",get selected(){return L()},onChange:l=>{if(z(l?.ID||-1),l){ne(l.ID);return}}}),b,h),s.$$keydown=l=>{if(l.stopPropagation(),N()?.length>0&&M(""),console.log(l.key),l.key==="ArrowUp"){const g=u()-1;if(g<-1)return;S(g)}else if(l.key==="ArrowDown")S(u()+1);else if(l.key==="Enter"&&u()>=0){const g=be(),I=parseInt(g.value||"0")||1,q=oe()[u()];if(q.skus?.length>0){M("Debe seleccionar 1 SKU.");return}o(q,I)}else{const g=l.key.toLocaleLowerCase();if(u()>=0&&(W.includes(g)||l.key==="Backspace")){const I=be();console.log("key backspace:: ",I.value),I&&(l.key==="Backspace"?I.value&&(I.value="",l.preventDefault()):(I.value+=g,l.preventDefault()))}else(ae.includes(g)||W.includes(g))&&Y(X+l.key)}},s.addEventListener("keypress",()=>!1),s.$$keyup=l=>{l.stopPropagation();const g=(l.target.value||"").toLowerCase().trim();Y(g)};var se=K;return typeof se=="function"?Pe(se,s):K=s,a(_,v(qe,{label:"Buscar SKU"}),de,ue),R.style.setProperty("height","calc(100% - 12px - 4.2rem)"),R.style.setProperty("position","relative"),a(R,v(ze,{get data(){return oe()},render:(l,g)=>{console.log("card rerender:: ",g,l);const I=()=>g===u();return v(Pt,{idx:g,get isSelected(){return I()},get ventasProductosMap(){return j()},productoStock:l,agregarProductoVenta:(q,_e)=>{o(l,q,_e)},setProductoSelected:S,get filterText(){return c()},onmouseover:()=>{u()>=0&&S(-1)}})}})),ee(()=>e.classList.toggle("column",!![2,3].includes(He()))),te(),e})(),(()=>{var e=m(_t),t=e.firstChild,[n,b]=f(t.nextSibling),h=n.nextSibling,i=h.nextSibling,w=i.firstChild,[s,_]=f(w.nextSibling),G=s.nextSibling,[H,de]=f(G.nextSibling),ue=H.nextSibling,[R,se]=f(ue.nextSibling),l=R.nextSibling,[g,I]=f(l.nextSibling),q=g.nextSibling,[_e,Ce]=f(q.nextSibling),Ie=i.nextSibling,[De,Ue]=f(Ie.nextSibling);return e.style.setProperty("width","calc(var(--page-width) * 0.52)"),a(e,(()=>{var p=Z(()=>!!N());return()=>p()&&(()=>{var y=m(gt);return a(y,N),y})()})(),n,b),a(i,v(Oe,{label:"Cliente",css:"w-06x",get saveOn(){return k()},save:"clienteID"}),s,_),a(i,v(le,{label:"Código",css:"w-05x"}),H,de),a(i,v(le,{label:"Sub Total",css:"ff-mono w-045x",getContent:()=>ve(k().subtotal)}),R,se),a(i,v(le,{label:"IGV",css:"ff-mono w-04x",getContent:()=>ve(k().igv)}),g,I),a(i,v(le,{label:"Total",css:"ff-mono w-045x",get content(){return k().total},getContent:()=>ve(k().total)}),_e,Ce),a(e,v(tt,{get data(){return $()},css:"w100 mt-12",tableCss:"w-page-t w100",maxHeight:"calc(100vh - 12rem - 12px)",columns:[{header:"Nº",getValue:(p,y)=>String(y+1)},{header:"Producto",render:p=>{const y=P().productosMap.get(p.productoID);let D=y?.Nombre||"";return p.isSubUnidad&&(D=`${y.SbnUnidad} de ${D}`),D}},{header:"SKU",render:p=>(console.log("skuss",p),p.skus?Z(()=>[...p.skus].map(([y,D])=>(()=>{var T=m(ft),ge=T.firstChild,[Se,Me]=f(ge.nextSibling),Te=Se.nextSibling,Ve=Te.nextSibling,[Ae,Le]=f(Ve.nextSibling);return a(T,y,Se,Me),a(T,D>1?(()=>{var fe=m(vt),Ne=fe.firstChild,Ee=Ne.nextSibling,[ke,Ke]=f(Ee.nextSibling);return ke.nextSibling,a(fe,D,ke,Ke),fe})():null,Ae,Le),T})())):"")},{header:"Cantidad",render:p=>pe(p.cantidad)},{header:"Monto",css:"ff-mono t-r",render:p=>{const D=P().productosMap.get(p.productoID).PrecioFinal*p.cantidad;return(()=>{var T=m($t);return a(T,()=>pe(D/100,2)),T})()}},{header:"...",headerStyle:{width:"2rem"},cellStyle:{padding:"0 4px"},render:p=>(()=>{var y=m(bt);return y.$$click=D=>{D.stopPropagation();const T=$().filter(ge=>ge.key!==p.key);E(T)},te(),y})()}]}),De,Ue),e})()]}})}function wt(r){const F=[2,3,4,5,6,8,10,12];return(()=>{var P=m(me);return a(P,v(ye,{each:F,children:C=>(()=>{var k=m(me);return k.$$click=O=>{O.stopPropagation(),r.onSelect(C)},a(k,C),ee(()=>V(k,`flex-center ff-bold ${A.button_venta_cantidad}`)),te(),k})()})),ee(()=>V(P,["flex p-rel ai-end h100",A.buttons_cantidad].join(" "))),P})()}const Pt=r=>{let F;ie(we(()=>r.isSelected,()=>{r.isSelected&&yt(F)}));const P=()=>{const c=Re(r.productoStock.producto.Nombre,r.filterText);return r.productoStock.isSubUnidad||r.productoStock.skus?.length>0?(()=>{var d=m(kt),u=d.firstChild,[S,L]=f(u.nextSibling),z=S.nextSibling,[N,M]=f(z.nextSibling),$=N.nextSibling,[E,K]=f($.nextSibling);return a(d,c,S,L),a(d,v(ce,{get when(){return r.productoStock.isSubUnidad},get children(){return[m(pt),(()=>{var j=m(mt);return a(j,()=>r.productoStock.producto.SbnUnidad),j})()]}}),N,M),a(d,v(ce,{get when(){return!r.productoStock.isSubUnidad},get children(){return m(St)}}),E,K),d})():c},C=()=>r.productoStock.skus?.length>0,k=Z(()=>{const c=r.productoStock.key;let d=r.ventasProductosMap.get(c)?.cantidad||0;if(c[0]==="P"){const u=`S${c.slice(1)}`,S=r.ventasProductosMap.get(u)?.cantidad||0;if(S>0){const L=r.productoStock.producto;d=d+Math.ceil(S/L.SbnCantidad)}}return r.productoStock.cant-d}),O=Z(()=>{let c=r.productoStock.skus||[];const d=r.ventasProductosMap.get(r.productoStock.key);return d?.skus?.size>0&&(c=c.filter(u=>d.skus.has(u.SKU)?u.Cantidad>d.skus.get(u.SKU):!0)),c.length>4&&(c=c.slice(0,4)),c});return(()=>{var c=m(xt),d=c.firstChild,u=d.firstChild,S=u.firstChild,L=S.nextSibling,[z,N]=f(L.nextSibling),M=u.nextSibling,$=M.firstChild,E=$.firstChild,K=E.nextSibling,[j,ne]=f(K.nextSibling),oe=j.nextSibling,[Q,re]=f(oe.nextSibling),J=$.nextSibling,ae=J.firstChild,W=J.nextSibling,X=W.nextSibling;c.$$mouseover=o=>{o.stopPropagation(),r.onmouseover()},d.$$click=()=>{r.setProductoSelected(r.idx)},a(u,P,z,N),M.style.setProperty("grid-template-columns","1fr 3.8rem 2.8rem 5rem"),a(E,P),a($,v(ce,{get when(){return C()},get children(){var o=m(ht);return o.style.setProperty("margin","0 -3px"),a(o,v(ye,{get each(){return O()},children:B=>(()=>{var e=m(me);return e.$$click=t=>{t.stopPropagation(),r.agregarProductoVenta(1,B.SKU)},a(e,()=>B.SKU),ee(()=>V(e,`h5 ${A.producto_sku}`)),te(),e})()})),o}}),j,ne),a($,v(ce,{get when(){return!C()},get children(){return v(wt,{onSelect:o=>{r.agregarProductoVenta(o)}})}}),Q,re);var Y=F;return typeof Y=="function"?Pe(Y,ae):F=ae,a(W,k),a(X,()=>pe(r.productoStock.producto.PrecioFinal/100,2)),ee(o=>{var B=!!r.isSelected,e=!!C(),t=r.idx===0?"8px":void 0,n=xe("flex p-rel jc-between",A.card_venta),b=A.card_venta_nombre,h=A.card_venta_nombre_line,i=`h100 ${A.card_venta_producto_ctn}`,w={"flex ai-center":!C()},s=`${A.card_venta_producto}`,_=xe("p-rel flex ai-center",A.input_cantidad);return B!==o.e&&c.classList.toggle("sld",o.e=B),e!==o.t&&c.classList.toggle("sku",o.t=e),t!==o.a&&((o.a=t)!=null?c.style.setProperty("margin-top",t):c.style.removeProperty("margin-top")),n!==o.o&&V(d,o.o=n),b!==o.i&&V(u,o.i=b),h!==o.n&&V(S,o.n=h),i!==o.s&&V($,o.s=i),o.h=Fe($,w,o.h),s!==o.r&&V(E,o.r=s),_!==o.d&&V(J,o.d=_),o},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0}),te(),c})()};je(["keyup","keydown","click","mouseover"]);export{Vt as default};
