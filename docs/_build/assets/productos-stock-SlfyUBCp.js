import{d as z,t as l,i as s}from"./web-B9EQUxsk.js";import{P as y,t as q,b as w,L as p,N as U}from"./main-CyvPQj02.js";import{a as i,e as H,c as n,S as k}from"./solid-DoXAfIeo.js";import{C as L}from"./Editables-BTYsjkzG.js";import{a as Q,I as b}from"./Input-HJvxZB2P.js";import{a as R,b as B}from"./Modals-DWfAM6fW.js";import{Q as G}from"./QTable-BPKrYQPg.js";import{S as A,m as J,P as W}from"./app-DjKDYt5Z.js";import{u as X,g as Y,p as Z}from"./productos-DJfvHqGN.js";import{u as ee}from"./sedes-almacenes-DFgJywOu.js";import"./http-BxXqqoH2.js";import"./store-DHPf-lLy.js";import"./main-CFEycXvd.js";var te=l('<div class="search-c4 mr-16 w14rem"><div><i class=icon-search></i></div><input class=w100 autocomplete=off type=text>'),re=l('<div class="flex ai-center c-red"><i class=icon-attention></i>Debe seleccionar un almacén.'),ae=l('<button class="bn1 b-blue mr-08"><i class=icon-floppy></i>Guardar (<!>)'),oe=l('<div class="flex ai-center jc-between mb-06"><div class="flex ai-center"></div><div class="flex ai-center"><button class="bn1 b-green"><i class=icon-plus>'),ne=l('<div class="w100-10 flex-wrap in-s2">'),se=l('<div class="flex ai-center jc-end"><div></div><div class="mr-02 ml-02">→</div><div class="c-red ff-bold">'),ce=l('<div class="c-red ff-bold">'),de=l("<i class=icon-ok>");function Pe(){const[u,h]=i([]),[C]=X(),[_]=ee(),[I,N]=i({almacenID:0}),[m,O]=i({}),[g,x]=i(-1),[d,P]=i(new Set),[V,K]=i(!1);let S=new Map;const $=async e=>{let t=[];p.standard("Obteniendo Registros...");try{t=await Y(e)}catch{p.remove();return}console.log("productos stock::",t),h(t),y.setValue("almacen_id",e);for(let r of t){const o=[r.ProductoID,r.SKU||"0",r.Lote||"0"].join("_");S.set(o,r)}p.remove()};H(()=>{if(g()==-1&&_()?.Almacenes?.length>0){const e=I();e.almacenID=y.getValueInt("almacen_id")||0,e.almacenID||(e.almacenID=_().Almacenes[0].ID),x(e.almacenID),N({...e}),$(e.almacenID)}});const j=e=>{if(!e.ProductoID||!e.Cantidad){U.failure("Debe seleccionar un producto y asignar una cantidad.");return}const t=[e.ProductoID,e.SKU||"0",e.Lote||"0"].join("_"),r=u();if(d().add(t),S.has(t)){const o=S.get(t);o.Cantidad=e.Cantidad,o.CostoUn=e.CostoUn||o.CostoUn,o._cantidadPrev=o._cantidadPrev||o.Cantidad||-1,o._hasUpdated=!0}else S.set(t,e),r.unshift(e),e._cantidadPrev=-1,e.AlmacenID=g(),e._hasUpdated=!0;P(new Set(d())),h([...r]),O({})},M=async()=>{const e=u().filter(r=>r._hasUpdated);if(e.length===0){U.failure("No hay registros a actualizar.");return}p.standard("Enviando registros...");let t;try{t=await Z(e)}catch{p.remove();return}for(let r of e)r._cantidadPrev=0;console.log("resultado obtenido::",t),h([...u()]),p.remove()},[D,T]=i(""),F=(e,t)=>{const r=new Set(e.map(a=>a.ProductoID)),o=[...e];for(let a of C().productos)r.has(a.ID)||o.push({AlmacenID:t,ProductoID:a.ID,Cantidad:0,_isVirtual:!0});return o};return n(W,{title:"Almacén Stock",get children(){return[(()=>{var e=oe(),t=e.firstChild,r=t.nextSibling,o=r.firstChild;return s(t,n(A,{get saveOn(){return I()},save:"almacenID",css:"w20rem s6 mb-02 mr-12",label:"",keys:"ID.Nombre",get options(){return _()?.Almacenes||[]},placeholder:" ALMACÉN",onChange:a=>{if(x(a?.ID||0),a){$(a.ID);return}}}),null),s(t,n(k,{get when(){return g()>0},get children(){return[(()=>{var a=te(),c=a.firstChild,f=c.nextSibling;return f.$$keyup=v=>{v.stopPropagation(),q(()=>{T((v.target.value||"").toLowerCase().trim())},150)},a})(),n(Q,{label:"Todos Productos",get checked(){return V()},onChange:a=>{K(a);let c=[];a?c=F(u(),g()):c=u().filter(f=>!f._isVirtual),h(c)}})]}}),null),s(t,n(k,{get when(){return!g()},get children(){return re()}}),null),s(r,n(k,{get when(){return d().size>0},get children(){var a=ae(),c=a.firstChild,f=c.nextSibling,v=f.nextSibling;return v.nextSibling,a.$$click=E=>{E.stopPropagation(),M()},s(a,()=>d().size,v),a}}),o),o.$$click=a=>{a.stopPropagation(),R([2])},e})(),n(G,{get data(){return u()},css:"w-page-t",tableCss:"",maxHeight:"calc(80vh - 13rem)",get filterText(){return D()},makeFilter:e=>C().productosMap.get(e.ProductoID)?.Nombre||"",columns:[{header:"Producto",css:"",render:e=>{const t=C().productosMap.get(e.ProductoID)?.Nombre||`P-${e.ProductoID}`;return J(t,D())}},{header:"Lote",css:"c-purple",getValue:e=>e.Lote},{header:"SKU",css:"c-purple",getValue:e=>e.SKU},{header:"Propiedades",css:"",getValue:e=>""},{header:"Stock",cardColumn:[3,2],field:"Nombre",css:"t-r",headerStyle:{width:"8rem"},render:e=>n(L,{saveOn:e,save:"",contentClass:"px-06 flex ai-center jc-end",inputClass:"t-c",type:"number",getValue:()=>e.Cantidad,onChange:t=>{if(e.Cantidad===t)return;e._cantidadPrev=e._cantidadPrev||e.Cantidad||-1,e.Cantidad=parseInt(t||"0"),e._hasUpdated=!0;const r=[e.ProductoID,e.SKU||"0",e.Lote||"0"].join("_");d().add(r),P(new Set(d()))},render:()=>{if(e._cantidadPrev&&e._cantidadPrev!==e.Cantidad){const t=e._cantidadPrev===-1?0:e._cantidadPrev;return(()=>{var r=se(),o=r.firstChild,a=o.nextSibling,c=a.nextSibling;return s(o,t),s(c,()=>e.Cantidad),r})()}else return e.Cantidad?String(e.Cantidad):(()=>{var t=ce();return s(t,()=>e.Cantidad),t})()}})},{header:"Costo UN",cardColumn:[3,2],cardCss:"h5 c-steel",css:"t-c",getValue:e=>e.CostoUn?w(e.CostoUn,2):"",render:e=>n(L,{saveOn:e,save:"CostoUn",contentClass:"px-06 flex ai-center jc-end",inputClass:"t-c",type:"number",onChange:t=>{e._hasUpdated=!0;const r=[e.ProductoID,e.SKU||"0",e.Lote||"0"].join("_");d().add(r),P(new Set(d()))},render:()=>e.CostoUn?w(e.CostoUn,2):""})},{header:"Stock Min",cardColumn:[3,2],cardCss:"h5 c-steel",css:"t-c",getValue:e=>""}]}),n(B,{title:"Nuevo Producto Stock",id:2,css:"py-12 px-12",get buttonSave(){return[de(),"Agregar"]},onSave:()=>{j(m())},get children(){var e=ne();return s(e,n(A,{get saveOn(){return m()},save:"ProductoID",css:"w-24x mb-10",label:"Producto1",keys:"ID.Nombre",get options(){return C()?.productos||[]},placeholder:" ",required:!0}),null),s(e,n(b,{get saveOn(){return m()},save:"SKU",css:"w-16x mb-10",label:"SKU"}),null),s(e,n(b,{get saveOn(){return m()},save:"Cantidad",required:!0,css:"w-08x mb-10",label:"Cantidad",type:"number"}),null),s(e,n(b,{get saveOn(){return m()},save:"Lote",css:"w-16x mb-10",label:"Lote",type:"text"}),null),s(e,n(b,{get saveOn(){return m()},save:"CostoUn",css:"w-08x mb-10",label:"Costo x Unidad",type:"number"}),null),e}})]}})}z(["keyup","click"]);export{Pe as default};
