import"../chunks/DsnmJJEf.js";import{e as B,g as Z,i as e,h as l,p as ke,f as h,c as _,r as m,s as d,t as Q,u as N,b as g,d as Ae,a as U,x as _e}from"../chunks/CaHRSXkO.js";import{s as se}from"../chunks/CrFq4NBa.js";import{i as C}from"../chunks/BLuAT40e.js";import{e as de,i as ue}from"../chunks/cG-FGtBW.js";import{d as Pe}from"../chunks/EZdBy8tr.js";import{I as ee}from"../chunks/C7ON8eMg.js";import{M as he}from"../chunks/CjajAhZ1.js";import{P as Fe}from"../chunks/DVpTgxki.js";import"../chunks/BB3LYAB-.js";import{S as Re}from"../chunks/Qtbri-_G.js";import{S as Le}from"../chunks/vPm9H9nQ.js";import{C as ze}from"../chunks/CLBGR4fI.js";import{V as Ve}from"../chunks/Cu5tfjpp.js";import{t as qe,N as Y,n as ne}from"../chunks/DP6SISrU.js";import{G as Ee,P as Ce,C as W,c as be}from"../chunks/BGtFDaK0.js";import{M as Me}from"../chunks/C6oF-QFB.js";import{s as xe,c as ye,d as le}from"../chunks/ZZ_SO04P.js";import{p as He}from"../chunks/DdsaxoiY.js";const we=[{id:1,name:"Gestión"},{id:2,name:"Seguridad"},{id:3,name:"Maestros"},{id:4,name:"Productos"},{id:5,name:"Reportes"}],Oe=[{id:1,name:"Visualizar",short:"VER",icon:"icon-eye",color:"#00c07d",color2:"#49c99c"},{id:2,name:"Editar",short:"EDITAR",icon:"icon-pencil",color:"#0080f9"},{id:3,name:"Eliminar",short:"ELIMINAR",icon:"icon-trash",color:"#0080f9"},{id:7,name:"Todo",short:"EDITAR",icon:"icon-shield",color:"#af12eb",color2:"#d35eff"}];class Be extends Ee{route="seguridad-accesos";useCache={min:5,ver:1};#e=B(Z([]));get accesos(){return e(this.#e)}set accesos(s){l(this.#e,s,!0)}#s=B(Z(new Map));get accesosMap(){return e(this.#s)}set accesosMap(s){l(this.#s,s,!0)}handler(s){this.accesos=s||[],this.accesosMap=new Map(this.accesos.map(c=>[c.id,c]))}constructor(){super(),this.fetch()}updateAcceso(s){const c=this.accesos.find(r=>r.id===s.id);c?Object.assign(c,s):this.accesos.unshift(s),this.accesosMap.set(s.id,s)}removeAcceso(s){this.accesos=this.accesos.filter(c=>c.id!==s),this.accesosMap.delete(s)}}class Je extends Ee{route="perfiles";useCache={min:5,ver:1};#e=B(Z([]));get perfiles(){return e(this.#e)}set perfiles(s){l(this.#e,s,!0)}#s=B(Z(new Map));get perfilesMap(){return e(this.#s)}set perfilesMap(s){l(this.#s,s,!0)}handler(s){const c=(s||[]).filter(r=>r.ss>0);for(const r of c){r.accesos=r.accesos||[],r.accesosMap=r.accesosMap||new Map;for(const R of r.accesos){const L=Math.floor(R/10),v=R-L*10;r.accesosMap.has(L)?r.accesosMap.get(L).push(v):r.accesosMap.set(L,[v])}}this.perfiles=c,this.perfilesMap=new Map(c.map(r=>[r.id,r]))}constructor(){super(),this.fetch()}updatePerfil(s){const c=this.perfiles.find(r=>r.id===s.id);c?Object.assign(c,s):this.perfiles.unshift(s),this.perfilesMap.set(s.id,s)}removePerfil(s){this.perfiles=this.perfiles.filter(c=>c.id!==s),this.perfilesMap.delete(s)}}const Ke=O=>Ce({data:O,route:"seguridad/accesos",refreshRoutes:["seguridad/accesos"]}),Qe=O=>{const s={...O};return delete s.accesosMap,delete s._open,Ce({data:s,route:"perfiles",refreshRoutes:["perfiles"]})};function ve(O,s){return new Map(O.map(c=>[c[s],c]))}var Ue=h('<div class="line-1 p-abs svelte-14n8npj"></div>'),We=h('<div class="absolute flex items-center justify-center i-edit svelte-14n8npj" role="button" tabindex="0"><i class="icon-pencil"></i></div> <div class="absolute flex items-center justify-center a-id c-purple svelte-14n8npj"> </div>',1),Xe=h('<div class="bnc1 svelte-14n8npj"><i></i></div>'),Ye=h('<div class="accion-btn svelte-14n8npj" role="button" tabindex="0"> </div>'),Ze=h('<div class="acciones-ac1 svelte-14n8npj"></div> <div class="acciones-ac2 w-full flex justify-center z-10 svelte-14n8npj"></div>',1),$e=h('<div role="button" tabindex="0"><div class="mr-4 svelte-14n8npj"> </div> <!> <!> <!></div>');function es(O,s){ke(s,!0);const c=ve(Oe,"id");let r=He(s,"perfilForm",15);const R=N(()=>r()?.accesosMap?.get(s.acceso.id)||[]),L=N(()=>{if(e(R).length===0||s.isEdit)return;const t=[...e(R)].sort().reverse(),o=c.get(t[0]||0);return o?.color2||o?.color||""});function v(t){if(W.deviceType===1||!r())return;t.stopPropagation();const o=r().accesosMap.get(s.acceso.id)||[];if(o.length>=s.acceso.acciones.length)r().accesosMap.delete(s.acceso.id);else{const p=s.acceso.acciones.filter(P=>!o.includes(P)),k=[...o,p[0]].filter(P=>P);r().accesosMap.set(s.acceso.id,k)}r(r().accesosMap=new Map(r().accesosMap),!0)}function u(t,o){if(t.stopPropagation(),!r())return;let p=[...r().accesosMap.get(s.acceso.id)||[]];p.includes(o)?p=p.filter(k=>k!==o):p.push(o),p.sort((k,P)=>P-k),p.length===0?r().accesosMap.delete(s.acceso.id):r().accesosMap.set(s.acceso.id,p),r(r().accesosMap=new Map(r().accesosMap),!0)}const ae=N(()=>{let t="acceso-card";return s.isEdit&&(t+=" sel"),W.deviceType>1&&(t+=" mobile"),t});var b=$e();b.__click=v,b.__keydown=t=>{(t.key==="Enter"||t.key===" ")&&(t.preventDefault(),v(t))};let te;var $=_(b),re=_($,!0);m($);var oe=d($,2);{var n=t=>{var o=Ue();let p;Q(()=>p=le(o,"",p,{"background-color":e(L)})),g(t,o)};C(oe,t=>{W.deviceType>1&&t(n)})}var E=d(oe,2);{var f=t=>{var o=We(),p=U(o);p.__click=A=>{A.stopPropagation(),s.onEdit()},p.__keydown=A=>{(A.key==="Enter"||A.key===" ")&&(A.preventDefault(),s.onEdit())};var k=d(p,2),P=_(k,!0);m(k),Q(()=>se(P,s.acceso.id)),g(t,o)};C(E,t=>{s.isEdit&&t(f)})}var x=d(E,2);{var y=t=>{var o=Ze(),p=U(o);de(p,21,()=>e(R),ue,(P,A)=>{const j=N(()=>c.get(e(A)));var T=_e(),q=U(T);{var X=J=>{var G=Xe();let I;var K=_(G);m(G),Q(()=>{I=le(G,"",I,{"background-color":e(j).color}),xe(K,1,ye(e(j).icon),"svelte-14n8npj")}),g(J,G)};C(q,J=>{e(j)&&J(X)})}g(P,T)}),m(p);var k=d(p,2);de(k,21,()=>s.acceso.acciones,ue,(P,A)=>{const j=N(()=>c.get(e(A))),T=N(()=>e(R).includes(e(A)));var q=_e(),X=U(q);{var J=G=>{var I=Ye();I.__click=H=>u(H,e(A)),I.__keydown=H=>{(H.key==="Enter"||H.key===" ")&&(H.preventDefault(),u(H,e(A)))};let K;var ie=_(I,!0);m(I),Q(()=>{K=le(I,"",K,{"background-color":e(T)?e(j).color:void 0,"border-color":e(T)?e(j).color:void 0,color:e(T)?"white":void 0}),se(ie,e(j).short)}),g(G,I)};C(X,G=>{e(j)&&G(J)})}g(P,q)}),m(k),g(t,o)};C(x,t=>{!s.isEdit&&r()&&t(y)})}m(b),Q(()=>{xe(b,1,ye(e(ae)),"svelte-14n8npj"),te=le(b,"",te,{"border-left-color":e(L)}),se(re,s.acceso.nombre)}),g(O,b),Ae()}Pe(["click","keydown"]);var ss=h('<span class="c-red">(Modo Edición)</span>'),as=h('<span class="mr-4">:</span> <span class="c-purple ml-4"> </span>',1),ts=h('<button class="bx-green mr-8" aria-label="Agregar acceso"><i class="icon-plus"></i></button>'),rs=h('<button class="bx-blue mr-8" aria-label="Guardar"><i class="icon-floppy"></i> <span class="max-md:hidden">Guardar</span></button>'),os=h('<i class="c-red icon-cancel"></i>'),is=h('<i class="icon-pencil"></i>'),cs=h('<button class="bn-white" aria-label="Editar"><!></button>'),ns=h('<div class="mb-8 px-12 py-8 bg-red-100 border border-red-400 text-red-700 rounded w-fit">Debe seleccionar un perfil para editar sus accesos.</div>'),ls=h('<div class="ff-bold h3 mb-6"> </div> <div class="grid grid-cols-3 gap-x-12 gap-y-8 mb-16"></div>',1),ds=h('<div class="grid grid-cols-24 gap-10 p-6"><!> <!> <!> <!> <!> <div class="col-span-24 flex items-center gap-12 mb-4"><div class="h-[1px] grow bg-gray-300"></div> <div class="ff-bold text-lg">Acciones</div> <div class="h-[1px] grow bg-gray-300"></div></div> <!></div>'),us=h('<div class="grid grid-cols-24 gap-10 p-6"><!> <!></div>'),vs=h('<div class="flex justify-between h-full gap-8 max-md:flex-col"><div class="w-full md:w-[32%]"><div class="flex justify-between items-center w-full mb-10"><div class="i-search mr-16 w-256"><div><i class="icon-search"></i></div> <input class="w-full" autocomplete="off" type="text"/></div> <div class="flex items-center"><button class="bx-green" aria-label="Agregar perfil"><i class="icon-plus"></i></button></div></div> <!></div> <div class="w-full md:w-[66.5%]"><div class="flex justify-between w-full mb-6"><div class="ff-bold text-xl"><span>Accesos</span> <!> <!></div> <div class="flex items-center max-md:absolute max-md:top-0 max-md:right-0"><!> <!> <!></div></div> <!> <!></div></div> <!> <!>',1);function Ds(O,s){ke(s,!0);const c=new Be,r=new Je,R=ve(we,"id"),L=ve(Me,"id");let v=B(Z({})),u=B(Z({})),ae=B(""),b=B(!1);const te=N(()=>{const n=new Map;for(let f of c.accesos)for(let x of f.modulosIDs){const y=[x,f.grupo].join("_");n.has(y)||n.set(y,[]),n.get(y).push(f);break}const E=[];for(let[f,x]of n){const[y,t]=f.split("_").map(o=>parseInt(o));E.push({moduleID:y,group:t,accesos:x,groupName:R.get(t)?.name||"",moduleName:L.get(y)?.name||""})}return E});async function $(){const n=e(v);if(!n.nombre||!n.orden||(n.acciones?.length||0)==0||!n.grupo||(n.modulosIDs?.length||0)===0){Y.failure("Faltan propiedades para agregar el acceso.");return}ne.Loading.standard("Actualizando Acceso...");try{const E=await Ke(n);(n.id||0)<=0&&(n.id=E.id),c.updateAcceso(n),l(v,{},!0),be(1),Y.success("Acceso guardado correctamente")}catch(E){Y.failure(E)}ne.Loading.remove()}async function re(n,E){const f=e(u);if(!f.nombre){Y.failure("Faltan propiedades para agregar el perfil.");return}if(E){f.accesos=[];for(let[t,o]of f.accesosMap){o.length===0&&f.accesosMap.delete(t);for(let p of o)f.accesos.push(t*10+p)}const x=c.accesos.filter(t=>f.accesosMap.has(t.id)),y=new Set;for(let t of x)for(let o of t.modulosIDs)y.add(o);f.modulosIDs=[...y]}ne.Loading.standard("Actualizando Perfil...");try{const x=await Qe(f);(f.id||0)<=0&&(f.id=x.id),f._open=!1,r.updatePerfil(f),l(u,{},!0),be(2),Y.success("Perfil guardado correctamente")}catch(x){Y.failure(x)}ne.Loading.remove()}const oe=[{header:"ID",headerCss:"w-54",cellCss:"text-center c-purple",getValue:n=>n.id},{header:"Perfil",highlight:!0,getValue:n=>n.nombre},{header:"...",headerCss:"w-42",cellCss:"text-center",id:"actions",buttonEditHandler:n=>{l(u,{...n,accesosMap:new Map(n.accesosMap)},!0),l(b,!1),W.openModal(2)}}];Fe(O,{title:"Perfiles & Accesos",children:(n,E)=>{var f=vs(),x=U(f),y=_(x),t=_(y),o=_(t),p=d(_(o),2);p.__keyup=a=>{a.stopPropagation(),qe(()=>{l(ae,(a.target.value||"").toLowerCase().trim(),!0)},150)},m(o);var k=d(o,2),P=_(k);P.__click=a=>{a.stopPropagation(),l(u,{ss:1,accesosMap:new Map},!0),W.openModal(2)},m(k),m(t);var A=d(t,2);Ve(A,{css:"w-full selectable",get columns(){return oe},maxHeight:"calc(100vh - 8rem - 16px)",get data(){return r.perfiles},get selected(){return e(u).id},get filterText(){return e(ae)},getFilterContent:a=>[a.nombre].filter(i=>i).join(" ").toLowerCase(),isSelected:(a,i)=>a.id===i,onRowClick:a=>{l(b,!1),a.id===e(u).id?l(u,{},!0):l(u,{...a,_open:!0,accesosMap:new Map(a.accesosMap)},!0)}}),m(y);var j=d(y,2),T=_(j),q=_(T),X=d(_(q),2);{var J=a=>{var i=ss();g(a,i)};C(X,a=>{e(b)&&a(J)})}var G=d(X,2);{var I=a=>{var i=as(),w=d(U(i),2),z=_(w,!0);m(w),Q(()=>se(z,e(u).nombre)),g(a,i)};C(G,a=>{e(u).id>0&&a(I)})}m(q);var K=d(q,2),ie=_(K);{var H=a=>{var i=ts();i.__click=w=>{w.stopPropagation(),l(v,{ss:1,modulosIDs:[],acciones:[],id:0,nombre:"",orden:0,grupo:0,upd:0},!0),W.openModal(1)},g(a,i)};C(ie,a=>{e(b)&&a(H)})}var pe=d(ie,2);{var je=a=>{var i=rs();i.__click=w=>{w.stopPropagation(),re(!1,!0)},g(a,i)};C(pe,a=>{e(u).id>0&&a(je)})}var Ie=d(pe,2);{var De=a=>{var i=cs();i.__click=M=>{M.stopPropagation(),l(b,!e(b))};var w=_(i);{var z=M=>{var F=os();g(M,F)},D=M=>{var F=is();g(M,F)};C(w,M=>{e(b)?M(z):M(D,!1)})}m(i),g(a,i)};C(Ie,a=>{e(u).id||a(De)})}m(K),m(T);var fe=d(T,2);{var Se=a=>{var i=ns();g(a,i)};C(fe,a=>{!e(b)&&!e(u).id&&a(Se)})}var Ne=d(fe,2);de(Ne,17,()=>e(te),ue,(a,i)=>{var w=ls(),z=U(w),D=_(z);m(z);var M=d(z,2);de(M,21,()=>e(i).accesos,ue,(F,V)=>{es(F,{get acceso(){return e(V)},get isEdit(){return e(b)},onEdit:()=>{l(v,{...e(V)},!0),W.openModal(1)},get perfilForm(){return e(u)},set perfilForm(ce){l(u,ce,!0)}})}),m(M),Q(()=>se(D,`${e(i).moduleName??""}${e(i).moduleName?" > ":""}${e(i).groupName??""}`)),g(a,w)}),m(j),m(x);var me=d(x,2);{let a=N(()=>(e(v)?.id>0?"Editando":"Creando")+" Acceso"),i=N(()=>!!e(v)?.id);he(me,{id:1,size:6,get title(){return e(a)},get isEdit(){return e(i)},onSave:()=>$(),children:(w,z)=>{var D=ds(),M=_(D);ee(M,{save:"nombre",css:"col-span-14",label:"Nombre",required:!0,get saveOn(){return e(v)},set saveOn(S){l(v,S,!0)}});var F=d(M,2);Le(F,{save:"grupo",css:"col-span-10",label:"Grupo",required:!0,get options(){return we},keyId:"id",keyName:"name",get saveOn(){return e(v)},set saveOn(S){l(v,S,!0)}});var V=d(F,2);ee(V,{save:"descripcion",css:"col-span-16",label:"Descripción",get saveOn(){return e(v)},set saveOn(S){l(v,S,!0)}});var ce=d(V,2);ee(ce,{save:"orden",css:"col-span-8",label:"Orden",type:"number",get saveOn(){return e(v)},set saveOn(S){l(v,S,!0)}});var ge=d(ce,2);Re(ge,{save:"modulosIDs",css:"col-span-24",label:"Módulos",get options(){return Me},keyId:"id",keyName:"name",get saveOn(){return e(v)},set saveOn(S){l(v,S,!0)}});var Ge=d(ge,4);ze(Ge,{save:"acciones",css:"col-span-24 flex-wrap gap-y-8",get options(){return Oe},keyId:"id",keyName:"name",type:"multiple",get saveOn(){return e(v)},set saveOn(S){l(v,S,!0)}}),m(D),g(w,D)},$$slots:{default:!0}})}var Te=d(me,2);{let a=N(()=>(e(u)?.id>0?"Editando":"Creando")+" Perfil"),i=N(()=>!!e(u)?.id);he(Te,{id:2,size:5,get title(){return e(a)},get isEdit(){return e(i)},onSave:()=>re(),onClose:()=>{l(u,{},!0)},children:(w,z)=>{var D=us(),M=_(D);ee(M,{save:"nombre",css:"col-span-24",label:"Nombre",required:!0,get saveOn(){return e(u)},set saveOn(V){l(u,V,!0)}});var F=d(M,2);ee(F,{save:"descripcion",css:"col-span-24",label:"Descripción",get saveOn(){return e(u)},set saveOn(V){l(u,V,!0)}}),m(D),g(w,D)},$$slots:{default:!0}})}g(n,f)},$$slots:{default:!0}}),Ae()}Pe(["keyup","click"]);export{Ds as component};
