var P=(e,t)=>{if(Array.isArray(e))return e.map(n=>P(n,t));if(typeof e!="object"||!e||!e._)return e;for(let[n,o]of Object.entries(e))if(t.has(n)){let a=t.get(n);if(a===n)continue;e[a]=o,delete e[n]}for(let n=0;n<e._.length;n+=2){let o=t.get(e._[n]);e[o]=P(e._[n+1],t)}return delete e._,e};var U="precache-v2",D="assets-v2",W="static-v2",I="app",b=new Map,B=[],Q=e=>{let t=e.indexOf("?");t!==-1&&(e=e.substring(0,t));let n=e.indexOf("@");n!==-1&&(e=e.substring(0,n)),e=e.substring(e.indexOf("/",8));let o=e.lastIndexOf(".");return e==="/"||(o===-1&&e[2])==="/"?[e,"*"]:[e,e.substring(o+1)]};self.addEventListener("install",e=>{e.waitUntil(caches.open(U).then(t=>t.addAll(B)).then(()=>self.skipWaiting()))});self.addEventListener("activate",e=>{let t=[U,D,W,I];e.waitUntil(self.clients.claim())});var Y=e=>{let t=e.indexOf('name="build-version"');if(t===-1)return null;let n=e.indexOf('"',t+28);return e.substring(n+1,n+7)},X=e=>{let t=Math.floor(Date.now()/1e3),n=parseInt(e.toLowerCase(),36)*10,o=t-n,a=Math.floor(o/60/60),l=Math.floor((o-a*60*60)/60),s=`${a} hora${a===1?"":"s"}`,c=`${s} ${l} min`;return a===0&&(c=`${l} min`),a>12&&(c=`m\xE1s de ${s}`),c},q={build:"",hasUpdated:!1};b.set(99,async e=>({...e,response:"pong"}));self._isLocal=self.origin.includes("localhost")||self.origin.includes("127.0.0.1");var A=0;b.set(7,async e=>{let t=Math.floor(Date.now()/1e3);if(A&&t-A<30)return console.log("Saltando revisi\xF3n de actualizaci\xF3n."),{};let n=e.version;if(!n)return console.log("No se envi\xF3 la version (build) a comparar."),{};let o=await Z(n);return A=t,{versionHasUpdated:o}});var Z=async e=>{q.build=e;let t=new Headers;t.append("pragma","no-cache"),t.append("cache-control","no-cache");try{let o=await(await fetch(self.location.origin+"/app-version",{method:"GET",headers:t})).text(),a=Y(o)||"";if(q.build=a,console.log("build code compare fetch:: ",e," | ",a),e!==a)return await caches.delete(D),X(a)}catch(n){console.warn("Error al obtener la versi\xF3n nueva (HTML)::",n)}return""},E=new Map,F=new Map,z=new Map,V=(e,t)=>{let n=z.get(e);n?n(t):console.log("No se encontr\xF3 el handler para el client:",e,"|",t)};self.addEventListener("fetch",e=>{let t=e.request,n=new URL(e.request.url);if(n.pathname==="/_sw_"){e.respondWith((async()=>{let i=parseInt(n.searchParams.get("accion")||"0"),d=parseInt(n.searchParams.get("req")||"0"),p=n.searchParams.get("env")||"main";E.has(e.clientId)||E.set(e.clientId,E.size+1);let g=E.get(e.clientId)||0,w=d*1e3+g,y=F.get(w)||0;if(y&&Date.now()-y<1e3){let M=Date.now()-y;return console.log("El id ",d," est\xE1 duplicado. | Client:",e.clientId,"| Hace:",M,"ms"),new Response(JSON.stringify({Error:"ReqID Duplicado."}),{headers:{"Content-Type":"application/json"}})}F.set(d,Date.now());let f=await self.clients.get(e.clientId);if(!f){console.warn(`No se encontr\xF3 el client con ID ${e.clientId}`);let M={error:`No se encontr\xF3 el client con ID ${e.clientId}`};return new Response(JSON.stringify(M),{headers:{"Content-Type":"application/json"}})}z.set(g,M=>{f.postMessage(M)});let T=b.get(i);if(!T){console.warn(`No se encontr\xF3 el handler para la acci\xF3n ${i}`);let M={error:`No se encontr\xF3 el handler para la acci\xF3n ${i}`};return new Response(JSON.stringify(M),{headers:{"Content-Type":"application/json"}})}let _=await e.request.clone().json();_.__enviroment__=p,_.__client__=g;let S={...await T(_),__response__:i,__req__:d},N="";return i===3&&(N=[_.route,_.cacheMode,d].join(" | ")),f.postMessage(S),console.log(`Respondiendo Fetch (${N}):`,H(S)),new Response(JSON.stringify({ok:1}),{headers:{"Content-Type":"application/json"}})})());return}else if(n.searchParams.has("__cache__")){let i=n.searchParams.get("__cache__")||"",[d,p,g]=i.split("."),w=parseInt(d),y=parseInt(p);if(isNaN(w)||isNaN(y))return console.warn(`Invalid __cache__ parameter format: ${i}. Bypassing cache.`),fetch(e.request);n.searchParams.delete("__cache__");let f=n.toString();console.log("buscando cach\xE9:",f),e.respondWith((async()=>{let T=await caches.open(`cache_req_${g}`),$=await T.match(f),_=Math.floor(Date.now()/1e3);if($){let v=parseInt($.headers.get("x-cache-timestamp")),S=parseInt($.headers.get("x-cache-version"));if(v&&S&&_-v<w*60&&S===y)return console.log(`Serving from cache: ${f}`),$;console.log(`Cache stale or version mismatch for ${f}. Fetching new.`)}try{let v=await fetch(e.request);if(v.status===200){let S=v.clone(),N=new Headers(S.headers);N.set("x-cache-timestamp",String(_)),N.set("x-cache-version",String(y));let M=new Response(await S.blob(),{status:S.status,statusText:S.statusText,headers:N});await T.put(f,M),console.log(`Fetched and cached: ${f}`)}else console.log("La consulta fall\xF3::",v.status);return v}catch(v){if(console.error(`Fetch failed for ${f}:`,v),$)return console.log(`Network failed, serving stale cache for ${f}`),$;throw v}})())}if(self._isLocal)return;let o=t.headers.get("Content-Type");if(console.log("event URL:: ",t.url,"|",o),!t.url.startsWith(self.location.origin))return;let[a,l]=Q(t.url);if(a==="/app-version")return;let s=new URL(t.url),c=s.origin===self.location.origin,r=t.mode==="navigate",h=!s.pathname.includes(".")||s.pathname==="/";l==="*"&&console.log("Re-routing Service Worker:: ",a);let u=["js","css","html","*","ts","mjs","tsx"].includes(l)?D:W,m="/";if(c&&r&&h){e.respondWith(caches.open(u).then(i=>i.match(m).then(d=>d&&!navigator.onLine?(console.log(`[Service Worker] Serving cached HTML for ${t.url} from ${m}`),d):(console.log(`[Service Worker] HTML not in cache, fetching from network: ${t.url}`),fetch(t).then(p=>{let g=p.headers.get("Content-Type");return p.ok&&g&&g.includes("text/html")&&(console.log(`[Service Worker] Caching new HTML response from ${t.url} as ${m}`),i.put(m,p.clone())),p}).catch(p=>d||(console.error(`[Service Worker] Network failed for HTML navigation: ${t.url}`,p),new Response("<h1>Offline</h1><p>You appear to be offline and this content is not cached.</p>",{headers:{"Content-Type":"text/html"}})))))));return}e.respondWith(caches.open("cache_").then(i=>i.match(t).then(d=>{if(d)if((d.headers.get("content-type")||"").includes("/html"))console.log("Es HTML!!",l);else return console.log("[Service Worker] Serving from cache:",t.url),d;return fetch(t).then(p=>{if(!p||p.status!==200||p.type!=="basic")return p;let g=t.headers.get("Content-Type");console.log("Guardando en cach\xE9: ",u," | "+t.url," | ",g);let w=p.clone();return console.log("[Service Worker] Caching new asset:",t.url),i.put(t,w),p}).catch(p=>(console.error("[Service Worker] Fetch failed:",t.url,p),new Response("Network error occurred.",{status:503,statusText:"Service Unavailable"})))})))});var x=new Map,K=async(e,t)=>{let n=t?t+"_"+I:I,a=await(await caches.open(n)).match(e),l=x.get(n);return!a&&l&&l.delete(e),a},k=async(e,t)=>{let n=t?t+"_"+I:I;x.has(n)||x.set(n,new Map);let o=x.get(n);if(o?.has(e)){if(await caches.has(n))return o.get(e);x.set(n,new Map)}let a=await caches.open(n),l=Date.now(),s=await a.match(e);if(s){let c=await s.json();if(c.__keys__){let r=new Map(c.__keys__),h=new Map([...r.entries()].map(u=>[u[1],u[0]]));c=P(c.content,h)}return console.log(`Cache response "${e}" in ${Date.now()-l}ms (v2)`),c}},C=async(e,t,n)=>{let o=n?n+"_"+I:I;x.has(o)||x.set(o,new Map);let a=await caches.open(o),l=x.get(o);if(!t){l?.delete(e),await a.delete(e);return}l?.set(e,t);let s=Date.now();typeof t!="string"&&(t=JSON.stringify(t));let c=new Response(t,{headers:{"Content-Type":"application/json","Content-Length":String(t.length)}});await a.put(e,c),console.log(`Cache put "${e}" in ${Date.now()-s}ms (v2)`)},H=e=>{let t={};for(let n in e){let o=e[n];typeof o=="number"||typeof o=="string"?t[n]=o:Array.isArray(o)?t[n]=`[${o.length}]`:o&&typeof o=="object"&&(t[n]=`{${Object.keys(o).join(", ")}}`)}return t};var ee=async(e,t)=>{let n=e.headers.get("Content-Type");if(e.status&&t.status&&(t.status.code=e.status,t.status.message=e.statusText),e.status===200){let o=e.body?.getReader(),a=new ReadableStream({start(c){return r();function r(){return o.read().then(({done:h,value:u})=>h?(c.close(),Promise.resolve()):(V(t.__client__,{__response__:5,bytes:u.length}),c.enqueue(u),r()))}}}),s=await new Response(a).text();return t&&(t.contentLength=s.length),Promise.resolve(JSON.parse(s))}else if(e.status===401)console.warn("Error 401, la sesi\xF3n ha expirado.");else if(e.status!==200)return console.log(e),!n||n.indexOf("/json")===-1?(console.log("Parseando como texto"),e.text()):(console.log("parseando como JSON"),e.json())},L=(e,t)=>{let n={};for(let[o,a]of Object.entries(e)){if(a&&!Array.isArray(a))continue;let l=0;for(let s of a||[]){let c=s.updated||s.upd||0;t?(l===0||c<l)&&(l=c):c>l&&(l=c)}n[o]=l}return n},R=(e,t,n)=>{let o=e.includes("?")?"&":"?";return typeof n=="string"&&(n=n.replace("?","&")),e+`${o}${t}=${n}`},j=!1,J=new Set;b.set(11,async()=>(j=!0,J=new Set,setTimeout(()=>{j=!1},8e3),{ok:1}));b.set(3,async e=>await ne(e));var O=e=>{let t=[e.route,e.partition?.value||"0"].join("_"),n=[e.__enviroment__||"main",e.module||"?"].join("_");return[t,n]};b.set(12,async e=>{let[t,n]=O(e),o=await k(t+"_updated",n);return console.log("lastSync obtenido (1):",e,e.route,t,o),{updatedStatus:o?.updatedStatus||{},updated:o?.fetchTime||0}});var G=async(e,t,n,o)=>{Array.isArray(n)&&(n={_default:n});let a=L(n),l=L(n,!0),s=!1;for(let[u,m]of Object.entries(a)){if(!m)continue;let i=t.updatedStatus[u];m!==i&&(t.updatedStatus[u]=m,s=!0),l[u]<i&&console.warn(`Cache Error: En "${e.route}" [${u}] se est\xE1n obteniendo registros con [updated] menor que el cach\xE9 (${(n[u]||[]).length} recibidos)`)}console.log("Fetch cache ha cambiado?:",s,"|",e.route,"|",a);let[c,r]=O(e),h=c+"_updated";if(!s&&e.cacheMode!=="updateOnly")n=await k(c,r);else if(s){let u=await k(c,r);console.log("cache obtenido:",c,r,e),self._isLocal&&console.log("prevResponse (old)",e.route,e.cacheMode,{...u});for(let[m,i]of Object.entries(n)){if((i||[]).length===0)continue;let d=e.keysIDs&&Object.hasOwn(e.keysIDs,m)?e.keysIDs[m]:e.keyID||"id",p=["ID","id"];typeof d=="string"&&!p.includes(d)&&p.unshift(d);let g=0,w=new Set,y=_=>{if(Array.isArray(d)){let v=[];for(let S of d)if(_[S])v.push(_[S]);else return g++,w.add(S),0;return d.map(S=>_[S]).join("_")}else{let v=_[p[0]]||_[p[1]]||_[p[2]];return v||(g++,w.add(p[0]),0)}},f=u[m]||[];if(!Array.isArray(f))continue;let T=new Map;for(let _ of f)T.set(y(_),_);for(let _ of i)T.set(y(_),_);console.log("records mapp cache::",f,i,T),g>0&&console.warn(`Cache Error: En "${e.route}" hay ${g} registros sin las siguientes keys ${[...w].join(", ")}`);let $=[];for(let _ of T.values())$.push(_);u[m]=$}self._isLocal&&console.log("prevResponse (new)",e.route,e.cacheMode,{...u}),C(c,u,r),n=u}else n=null;return t.fetchTime=o,C(h,t,r),n},te=new Set;b.set(21,async e=>{let t=(e.__req__||0)*1e3+e.__client__;te.add(t)});var ne=async e=>{console.log("Obteniendo fetch service worker:",e.route,"|",e.cacheMode,"|",e.__req__,"|",e.__version__);let[t,n]=O(e),o=t+"_updated",a=r=>{if(!r||Object.keys(r).length===0)return["sin registros"];let h=[];for(let u of Object.keys(r))h.push(`${u}=${(r[u]||[]).length}`);return h},l={fetchTime:0,updatedStatus:{},__version__:e.__version__},s=await k(o,n)||l;if(s.fetchTime&&s.__version__!==e.__version__)console.log(`Linmpiando cach\xE9, difererente versi\xF3n ${e.__version__} > ${s.__version__}. Route ${e.route}`),s=l,await C(o,s,n),await C(t,null,n);else{let r=await K(t,n);s.fetchTime&&!r?(await C(o,l,n),s=l):r&&!s.fetchTime&&await C(t,null,n)}if(e.cacheMode==="offline"){let r=await k(t,n);if(r&&r.__version__===e.__version__){let h=L(r);for(let[u,m]of Object.entries(h)){let i=!1;s.updatedStatus[u]!==m&&(console.log("El updatedStatus difiere:",e.route,"|",u,"|",s.updatedStatus[u]," vs ",m),s.updatedStatus[u]=m,i=!0),i&&C(o,s,n)}}return console.log("Enviando fetch response (offline):",e.route),console.log(`${e.route}: Retornando registros "${e.cacheMode||"normal"}". ${a(r).join(" | ")}`),{content:r?._default?r._default:r}}let c=Math.floor(Date.now()/1e3);e.status={code:200,message:""};try{let r=e.routeParsed||e.route;if(e.partition&&e.partition.value){let d=e.partition.param||e.partition.key;r=R(r,d,e.partition.value)}let h=s&&s.updatedStatus&&s.fetchTime;console.log("hasCache",e.route,s);let u=e.fields||[];for(let d of u)s.updatedStatus[d]||0||(r=R(r,d,0));if(h){if(s.updatedStatus._default)r=R(r,"updated",s.updatedStatus._default);else{r=R(r,"updated",s.fetchTime);for(let[y,f]of Object.entries(s.updatedStatus))u.length>0&&!u.includes(y)||(r=R(r,y,f))}let d=e.cacheSyncTime||e.useCache?.min||0,p=s.fetchTime+d*60,g=p-c,w=e.cacheMode==="refresh";s.forceNetwork?(console.log("Forzando fetch por flag forceNetwork en ILastSync:",e.route),w=!0,s.forceNetwork=!1,await C(o,s,n)):j&&!J.has(t)?(console.log("Forzando fetch por flag global:",e.route),w=!0):g<=0&&(console.log("Preparando fetch: ",e.route," | Last: ",s.fetchTime,"| Remainig:",g),w=!0);for(let y of e.fields||[])s.updatedStatus[y]||0||(w=!0);if(!w){let y=p-c;if(console.log(`Obviando sync fech "${t}". Quedan ${y}s`),e.cacheMode==="updateOnly")return console.log(e.route,"Retornando null por 'updated only'"),{content:null};{let f=await k(t,n);return console.log(`${e.route}: Retornando registros "${e.cacheMode||"normal"}`,H(f)),{content:f?._default?f._default:f}}}}console.log(`Realizando fetch (${r})...`);let m=await self.fetch(r,{headers:e.headers});if(m.status&&m.status!==200)return{error:await m.text()};let i=await ee(m,e)||{};if(Array.isArray(i.response)&&typeof i.message=="string"&&(i=i.response),Array.isArray(i)&&(i={_default:i}),i.__version__=e.__version__,console.log(`Fetch response recibida! (${r}) | Has-cach\xE9: ${h}`),h)console.log("prevResponse (hasCache)",e.route,e.cacheMode,{...i}),i=await G(e,s,i,c);else{let d=L(i);Object.assign(s,{fetchTime:c,updatedStatus:d}),C(o,s,n),console.log("prevResponse (recent)",e.route,e.cacheMode,{...i}),C(t,i,n)}return console.log(`${e.route}: Retornando registros "${e.cacheMode||"normal"}". ${a(i).join(" | ")}`),{content:i}}catch(r){return console.log("Fetch Error::",r),{error:r}}};b.set(13,async e=>{let[t,n]=O(e.args)+"_updated",o=await k(t,n)||{fetchTime:0,updatedStatus:{}},a=Math.floor(Date.now()/1e3)-5;e.args.__enviroment__=e.__enviroment__,console.log("Guardando external fech response en cach\xE9:",e.args.route),G(e.args,o,e.response,a)});b.set(14,async e=>{let[t,n]=O(e),o=t+"_updated",a=await k(o,n)||{fetchTime:0,updatedStatus:{}};return a.forceNetwork=!0,await C(o,a,n),console.log(`ForceNetwork set to true for key: ${o}`),{ok:1}});b.set(15,async e=>{let t={route:e.route,module:e.module,partition:{value:e.partValue}},[n,o]=O(t),a=await k(n,o);if(!a)return[];let l=a[e.propInResponse||"_default"];if(!l)return[];if(e.filter){let s=e.filter.split(",").filter(r=>r).map(r=>{let h=r.split("=");return isNaN(h[1])?h.push(0):h.push(parseInt(h[1])),h});console.log("keyValues filters:",s);let c=[];for(let r of l)for(let h of s){let u=r[h[0]];(u===h[1]||u===h[2])&&c.push(r)}return c}else return a});b.set(22,async e=>{console.log("obteniendo cantidad de registros obtenidos");let t=await caches.keys();console.log("cache stores::",t,"| Env:",e.__enviroment__);let n=[];for(let o of t){if(!o.includes("_"))continue;let[a,l]=o.split("_");a===e.__enviroment__&&n.push({name:o,module:l,size:0})}return await Promise.all(n.map(o=>new Promise((a,l)=>{let s;caches.open(o.name).then(c=>(s=c,s.keys())).then(c=>Promise.all(c.map(async r=>{try{let h=await s.match(r);if(h){let u=h.headers.get("Content-Length")||h.headers.get("content-length");o.size||(o.size=0),o.size+=parseInt(u||"0",10)}else console.warn(`Service Worker: No matching response found for request in cache '${o.name}':`,r.url)}catch(h){console.error(`Service Worker: Error matching request or getting size for ${r.url}:`,h)}}))).then(()=>{a(0)}).catch(c=>{console.log("Error al obtener informacion del cach\xE9:",c),l(c)})}))),console.log("cacheStats",n),{cacheStats:n}});b.set(23,async e=>(console.log(`Eliminando cach\xE9 "${e.cacheName}" (Enviroment ${e.__enviroment__})...`),await caches.delete(e.cacheName),console.log(`Cach\xE9 "${e.cacheName}" eliminado! (Enviroment ${e.__enviroment__})...`),{ok:1}));b.set(24,async e=>{let t=[e.__enviroment__||"main",e.module||"?"].join("_");console.log("Setting ForceNerwork for routes: ",e.routes);let o=await(await caches.open(t+"_"+I)).keys(),a=new Set;for(let l of o){let s=l.url.split("/")[3];if(s){console.log("buscando request::",s);for(let c of e.routes)if(s.startsWith(c)&&s.endsWith("_updated")){let r=await k(s,t);r.forceNetwork=!0,await C(s,r,t),a.add(c);break}}}return console.log(`ForceNetwork = true for routes: ${[...a].join(", ")} | In ${o.length}`),{ok:1}});
//# sourceMappingURL=sw.js.map
