var P=(e,t)=>{if(Array.isArray(e))return e.map(n=>P(n,t));if(typeof e!="object"||!e||!e._)return e;for(let[n,o]of Object.entries(e))if(t.has(n)){let a=t.get(n);if(a===n)continue;e[a]=o,delete e[n]}for(let n=0;n<e._.length;n+=2){let o=t.get(e._[n]);e[o]=P(e._[n+1],t)}return delete e._,e};var F="precache-v2",H="assets-v2",W="static-v2",I="app",v=new Map,B=[],Q=e=>{let t=e.indexOf("?");t!==-1&&(e=e.substring(0,t));let n=e.indexOf("@");n!==-1&&(e=e.substring(0,n)),e=e.substring(e.indexOf("/",8));let o=e.lastIndexOf(".");return e==="/"||(o===-1&&e[2])==="/"?[e,"*"]:[e,e.substring(o+1)]};self.addEventListener("install",e=>{e.waitUntil(caches.open(F).then(t=>t.addAll(B)).then(()=>self.skipWaiting()))});self.addEventListener("activate",e=>{let t=[F,H,W,I];e.waitUntil(self.clients.claim())});var Y=e=>{let t=e.indexOf('name="build-version"');if(t===-1)return null;let n=e.indexOf('"',t+28);return e.substring(n+1,n+7)},X=e=>{let t=Math.floor(Date.now()/1e3),n=parseInt(e.toLowerCase(),36)*10,o=t-n,a=Math.floor(o/60/60),l=Math.floor((o-a*60*60)/60),s=`${a} hora${a===1?"":"s"}`,c=`${s} ${l} min`;return a===0&&(c=`${l} min`),a>12&&(c=`m\xE1s de ${s}`),c},j={build:"",hasUpdated:!1};v.set(99,async e=>({...e,response:"pong"}));self._isLocal=self.origin.includes("localhost")||self.origin.includes("127.0.0.1");var A=0;v.set(7,async e=>{let t=Math.floor(Date.now()/1e3);if(A&&t-A<30)return console.log("Saltando revisi\xF3n de actualizaci\xF3n."),{};let n=e.version;if(!n)return console.log("No se envi\xF3 la version (build) a comparar."),{};let o=await Z(n);return A=t,{versionHasUpdated:o}});var Z=async e=>{j.build=e;let t=new Headers;t.append("pragma","no-cache"),t.append("cache-control","no-cache");try{let o=await(await fetch(self.location.origin+"/app-version",{method:"GET",headers:t})).text(),a=Y(o)||"";if(j.build=a,console.log("build code compare fetch:: ",e," | ",a),e!==a)return await caches.delete(H),X(a)}catch(n){console.warn("Error al obtener la versi\xF3n nueva (HTML)::",n)}return""},E=new Map,U=new Map,K=new Map,V=(e,t)=>{let n=K.get(e);n?n(t):console.log("No se encontr\xF3 el handler para el client:",e,"|",t)};self.addEventListener("fetch",e=>{let t=e.request,n=new URL(e.request.url);if(n.pathname==="/_sw_"){e.respondWith((async()=>{let i=parseInt(n.searchParams.get("accion")||"0"),p=parseInt(n.searchParams.get("req")||"0"),h=n.searchParams.get("env")||"main";E.has(e.clientId)||E.set(e.clientId,E.size+1);let g=E.get(e.clientId)||0,w=p*1e3+g,m=U.get(w)||0;if(m&&Date.now()-m<1e3){let M=Date.now()-m;return console.log("El id ",p," est\xE1 duplicado. | Client:",e.clientId,"| Hace:",M,"ms"),new Response(JSON.stringify({Error:"ReqID Duplicado."}),{headers:{"Content-Type":"application/json"}})}U.set(p,Date.now());let f=await self.clients.get(e.clientId);if(!f){console.warn(`No se encontr\xF3 el client con ID ${e.clientId}`);let M={error:`No se encontr\xF3 el client con ID ${e.clientId}`};return new Response(JSON.stringify(M),{headers:{"Content-Type":"application/json"}})}K.set(g,M=>{f.postMessage(M)});let b=v.get(i);if(!b){console.warn(`No se encontr\xF3 el handler para la acci\xF3n ${i}`);let M={error:`No se encontr\xF3 el handler para la acci\xF3n ${i}`};return new Response(JSON.stringify(M),{headers:{"Content-Type":"application/json"}})}let C=await e.request.clone().json();C.__enviroment__=h,C.__client__=g;let $={...await b(C),__response__:i,__req__:p},N="";return i===3&&(N=[C.route,C.cacheMode,p].join(" | ")),f.postMessage($),console.log(`Respondiendo Fetch (${N}):`,D($)),new Response(JSON.stringify({ok:1}),{headers:{"Content-Type":"application/json"}})})());return}else if(n.searchParams.has("__cache__")){let i=n.searchParams.get("__cache__")||"",[p,h,g]=i.split("."),w=parseInt(p),m=parseInt(h);if(isNaN(w)||isNaN(m))return console.warn(`Invalid __cache__ parameter format: ${i}. Bypassing cache.`),fetch(e.request);n.searchParams.delete("__cache__");let f=n.toString();console.log("buscando cach\xE9:",f),e.respondWith((async()=>{let b=await caches.open(`cache_req_${g}`),y=await b.match(f),C=Math.floor(Date.now()/1e3);if(y){let k=parseInt(y.headers.get("x-cache-timestamp")),$=parseInt(y.headers.get("x-cache-version"));if(k&&$&&C-k<w*60&&$===m)return console.log(`Serving from cache: ${f}`),y;console.log(`Cache stale or version mismatch for ${f}. Fetching new.`)}try{let k=await fetch(e.request);if(k.status===200){let $=k.clone(),N=new Headers($.headers);N.set("x-cache-timestamp",String(C)),N.set("x-cache-version",String(m));let M=new Response(await $.blob(),{status:$.status,statusText:$.statusText,headers:N});await b.put(f,M),console.log(`Fetched and cached: ${f}`)}else console.log("La consulta fall\xF3::",k.status);return k}catch(k){if(console.error(`Fetch failed for ${f}:`,k),y)return console.log(`Network failed, serving stale cache for ${f}`),y;throw k}})())}if(self._isLocal)return;let o=t.headers.get("Content-Type");if(console.log("event URL:: ",t.url,"|",o),!t.url.startsWith(self.location.origin))return;let[a,l]=Q(t.url);if(a==="/app-version")return;let s=new URL(t.url),c=s.origin===self.location.origin,r=t.mode==="navigate",d=!s.pathname.includes(".")||s.pathname==="/";l==="*"&&console.log("Re-routing Service Worker:: ",a);let u=["js","css","html","*","ts","mjs","tsx"].includes(l)?H:W,_="/";if(c&&r&&d){e.respondWith(caches.open(u).then(i=>i.match(_).then(p=>p&&!navigator.onLine?(console.log(`[Service Worker] Serving cached HTML for ${t.url} from ${_}`),p):(console.log(`[Service Worker] HTML not in cache, fetching from network: ${t.url}`),fetch(t).then(h=>{let g=h.headers.get("Content-Type");return h.ok&&g&&g.includes("text/html")&&(console.log(`[Service Worker] Caching new HTML response from ${t.url} as ${_}`),i.put(_,h.clone())),h}).catch(h=>p||(console.error(`[Service Worker] Network failed for HTML navigation: ${t.url}`,h),new Response("<h1>Offline</h1><p>You appear to be offline and this content is not cached.</p>",{headers:{"Content-Type":"text/html"}})))))));return}e.respondWith(caches.open("cache_").then(i=>i.match(t).then(p=>{if(p)if((p.headers.get("content-type")||"").includes("/html"))console.log("Es HTML!!",l);else return console.log("[Service Worker] Serving from cache:",t.url),p;return fetch(t).then(h=>{if(!h||h.status!==200||h.type!=="basic")return h;let g=t.headers.get("Content-Type");console.log("Guardando en cach\xE9: ",u," | "+t.url," | ",g);let w=h.clone();return console.log("[Service Worker] Caching new asset:",t.url),i.put(t,w),h}).catch(h=>(console.error("[Service Worker] Fetch failed:",t.url,h),new Response("Network error occurred.",{status:503,statusText:"Service Unavailable"})))})))});var x=new Map,z=async(e,t)=>{let n=t?t+"_"+I:I,a=await(await caches.open(n)).match(e),l=x.get(n);return!a&&l&&l.delete(e),a},T=async(e,t)=>{let n=t?t+"_"+I:I;x.has(n)||x.set(n,new Map);let o=x.get(n);if(o?.has(e)){if(await caches.has(n))return o.get(e);x.set(n,new Map)}let a=await caches.open(n),l=Date.now(),s=await a.match(e);if(s){let c=await s.json();if(c.__keys__){let r=new Map(c.__keys__),d=new Map([...r.entries()].map(u=>[u[1],u[0]]));c=P(c.content,d)}return console.log(`Cache response "${e}" in ${Date.now()-l}ms (v2)`),c}},S=async(e,t,n)=>{let o=n?n+"_"+I:I;x.has(o)||x.set(o,new Map);let a=await caches.open(o),l=x.get(o);if(!t){l?.delete(e),await a.delete(e);return}l?.set(e,t);let s=Date.now();typeof t!="string"&&(t=JSON.stringify(t));let c=new Response(t,{headers:{"Content-Type":"application/json","Content-Length":String(t.length)}});await a.put(e,c),console.log(`Cache put "${e}" in ${Date.now()-s}ms (v2)`)},D=e=>{let t={};for(let n in e){let o=e[n];typeof o=="number"||typeof o=="string"?t[n]=o:Array.isArray(o)?t[n]=`[${o.length}]`:o&&typeof o=="object"&&(t[n]=`{${Object.keys(o).join(", ")}}`)}return t};var ee=async(e,t)=>{let n=e.headers.get("Content-Type");if(e.status&&t.status&&(t.status.code=e.status,t.status.message=e.statusText),e.status===200){let o=e.body?.getReader(),a=new ReadableStream({start(c){return r();function r(){return o.read().then(({done:d,value:u})=>d?(c.close(),Promise.resolve()):(V(t.__client__,{__response__:5,bytes:u.length}),c.enqueue(u),r()))}}}),s=await new Response(a).text();return t&&(t.contentLength=s.length),Promise.resolve(JSON.parse(s))}else if(e.status===401)console.warn("Error 401, la sesi\xF3n ha expirado.");else if(e.status!==200)return console.log(e),!n||n.indexOf("/json")===-1?(console.log("Parseando como texto"),e.text()):(console.log("parseando como JSON"),e.json())},L=(e,t)=>{let n={};for(let[o,a]of Object.entries(e)){if(a&&!Array.isArray(a))continue;let l=0;for(let s of a||[]){let c=s.updated||s.upd||0;t?(l===0||c<l)&&(l=c):c>l&&(l=c)}n[o]=l}return n},O=(e,t,n)=>{let o=e.includes("?")?"&":"?";return typeof n=="string"&&(n=n.replace("?","&")),e+`${o}${t}=${n}`},q=!1,J=new Set;v.set(11,async()=>(q=!0,J=new Set,setTimeout(()=>{q=!1},8e3),{ok:1}));v.set(3,async e=>await se(e));var R=e=>{let t=[e.route,e.partition?.value||"0"].join("_"),n=[e.__enviroment__||"main",e.module||"?"].join("_");return[t,n]};v.set(12,async e=>{let[t,n]=R(e),o=await T(t+"_updated",n);return console.log("lastSync obtenido (1):",e,e.route,t,o),{updatedStatus:o?.updatedStatus||{},updated:o?.fetchTime||0}});var te=(e,t)=>e.keysIDs&&Object.hasOwn(e.keysIDs,t)?e.keysIDs[t]:e.keyID||"id",ne=(e,t)=>{if(typeof t=="string")return e[t]||e.ID||0;if(Array.isArray(t)){let n=[];for(let o of t)if(e[o])n.push(e[o]);else return 0;return n.join("_")}else return 0},G=async(e,t,n,o)=>{Array.isArray(n)&&(n={_default:n});let a=L(n),l=L(n,!0),s=!1;for(let[u,_]of Object.entries(a)){if(!_)continue;let i=t.updatedStatus[u];_!==i&&(t.updatedStatus[u]=_,s=!0),l[u]<i&&console.warn(`Cache Error: En "${e.route}" [${u}] se est\xE1n obteniendo registros con [updated] menor que el cach\xE9 (${(n[u]||[]).length} recibidos)`)}console.log("Fetch cache ha cambiado?:",s,"|",e.route,"|",a);let[c,r]=R(e),d=c+"_updated";if(!s&&e.cacheMode!=="updateOnly")n=await T(c,r);else if(s){let u=await T(c,r);console.log("cache obtenido:",c,r,e),self._isLocal&&console.log("prevResponse (old)",e.route,e.cacheMode,{...u});let _={};for(let[i,p]of Object.entries(n)){if((p||[]).length===0)continue;let h=te(e,i),g=0;_[String(h)]=(_[String(h)]||0)+p.length;let w=y=>{let C=ne(y,h);return C||g++,C},m=u[i]||[];if(!Array.isArray(m))continue;let f=new Map;for(let y of m)f.set(w(y),y);for(let y of p)f.set(w(y),y);g>0&&console.warn(`Cache Error: En "${e.route}" (${i}) hay ${g} registros sin la key: ${h}`),console.log("Cache usedKeysCount",_);let b=[];for(let y of f.values())b.push(y);u[i]=b}self._isLocal&&console.log("prevResponse (new)",e.route,e.cacheMode,{...u}),S(c,u,r),n=u}else n=null;return t.fetchTime=o,S(d,t,r),n},oe=new Set;v.set(21,async e=>{let t=(e.__req__||0)*1e3+e.__client__;oe.add(t)});var se=async e=>{console.log("Obteniendo fetch service worker:",e.route,"|",e.cacheMode,"|",e.__req__,"|",e.__version__);let[t,n]=R(e),o=t+"_updated",a=r=>{if(!r||Object.keys(r).length===0)return["sin registros"];let d=[];for(let u of Object.keys(r))d.push(`${u}=${(r[u]||[]).length}`);return d},l={fetchTime:0,updatedStatus:{},__version__:e.__version__},s=await T(o,n)||l;if(s.fetchTime&&s.__version__!==e.__version__)console.log(`Linmpiando cach\xE9, difererente versi\xF3n ${e.__version__} > ${s.__version__}. Route ${e.route}`),s=l,await S(o,s,n),await S(t,null,n);else{let r=await z(t,n);s.fetchTime&&!r?(await S(o,l,n),s=l):r&&!s.fetchTime&&await S(t,null,n)}if(e.cacheMode==="offline"){let r=await T(t,n);if(r&&r.__version__===e.__version__){let d=L(r);for(let[u,_]of Object.entries(d)){let i=!1;s.updatedStatus[u]!==_&&(console.log("El updatedStatus difiere:",e.route,"|",u,"|",s.updatedStatus[u]," vs ",_),s.updatedStatus[u]=_,i=!0),i&&S(o,s,n)}}return console.log("Enviando fetch response (offline):",e.route),console.log(`${e.route}: Retornando registros "${e.cacheMode||"normal"}". ${a(r).join(" | ")}`),{content:r?._default?r._default:r}}let c=Math.floor(Date.now()/1e3);e.status={code:200,message:""};try{let r=e.routeParsed||e.route;if(e.partition&&e.partition.value){let p=e.partition.param||e.partition.key;r=O(r,p,e.partition.value)}let d=s&&s.updatedStatus&&s.fetchTime;console.log("hasCache",e.route,s);let u=e.fields||[];for(let p of u)s.updatedStatus[p]||0||(r=O(r,p,0));if(d){if(s.updatedStatus._default)r=O(r,"updated",s.updatedStatus._default);else{let m=0;for(let[f,b]of Object.entries(s.updatedStatus))(m===0||b<m)&&(m=b),!(u.length>0&&!u.includes(f))&&(r=O(r,f,b));r=O(r,"updated",m)}let p=e.cacheSyncTime||e.useCache?.min||0,h=s.fetchTime+p*60,g=h-c,w=e.cacheMode==="refresh";s.forceNetwork?(console.log("Forzando fetch por flag forceNetwork en ILastSync:",e.route),w=!0,s.forceNetwork=!1,await S(o,s,n)):q&&!J.has(t)?(console.log("Forzando fetch por flag global:",e.route),w=!0):g<=0&&(console.log("Preparando fetch: ",e.route," | Last: ",s.fetchTime,"| Remainig:",g),w=!0);for(let m of e.fields||[])s.updatedStatus[m]||0||(w=!0);if(!w){let m=h-c;if(console.log(`Obviando sync fech "${t}". Quedan ${m}s`),e.cacheMode==="updateOnly")return console.log(e.route,"Retornando null por 'updated only'"),{content:null};{let f=await T(t,n);return console.log(`${e.route}: Retornando registros "${e.cacheMode||"normal"}`,D(f)),{content:f?._default?f._default:f}}}}console.log(`Realizando fetch (${r})...`);let _=await self.fetch(r,{headers:e.headers});if(_.status&&_.status!==200)return{error:await _.text()};let i=await ee(_,e)||{};if(Array.isArray(i.response)&&typeof i.message=="string"&&(i=i.response),Array.isArray(i)&&(i={_default:i}),i.__version__=e.__version__,console.log(`Fetch response recibida! (${r}) | Has-cach\xE9: ${d}`),d)console.log("prevResponse (hasCache)",e.route,e.cacheMode,{...i}),i=await G(e,s,i,c);else{let p=L(i);Object.assign(s,{fetchTime:c,updatedStatus:p}),S(o,s,n),console.log("prevResponse (recent)",e.route,e.cacheMode,{...i}),S(t,i,n)}return console.log(`${e.route}: Retornando registros "${e.cacheMode||"normal"}". ${a(i).join(" | ")}`),{content:i}}catch(r){return console.log("Fetch Error::",r),{error:r}}};v.set(13,async e=>{let[t,n]=R(e.args)+"_updated",o=await T(t,n)||{fetchTime:0,updatedStatus:{}},a=Math.floor(Date.now()/1e3)-5;e.args.__enviroment__=e.__enviroment__,console.log("Guardando external fech response en cach\xE9:",e.args.route),G(e.args,o,e.response,a)});v.set(14,async e=>{let[t,n]=R(e),o=t+"_updated",a=await T(o,n)||{fetchTime:0,updatedStatus:{}};return a.forceNetwork=!0,await S(o,a,n),console.log(`ForceNetwork set to true for key: ${o}`),{ok:1}});v.set(15,async e=>{let t={route:e.route,module:e.module,partition:{value:e.partValue}},[n,o]=R(t),a=await T(n,o);if(!a)return[];let l=a[e.propInResponse||"_default"];if(!l)return[];if(e.filter){let s=e.filter.split(",").filter(r=>r).map(r=>{let d=r.split("=");return isNaN(d[1])?d.push(0):d.push(parseInt(d[1])),d});console.log("keyValues filters:",s);let c=[];for(let r of l)for(let d of s){let u=r[d[0]];(u===d[1]||u===d[2])&&c.push(r)}return c}else return a});v.set(22,async e=>{console.log("obteniendo cantidad de registros obtenidos");let t=await caches.keys();console.log("cache stores::",t,"| Env:",e.__enviroment__);let n=[];for(let o of t){if(!o.includes("_"))continue;let[a,l]=o.split("_");a===e.__enviroment__&&n.push({name:o,module:l,size:0})}return await Promise.all(n.map(o=>new Promise((a,l)=>{let s;caches.open(o.name).then(c=>(s=c,s.keys())).then(c=>Promise.all(c.map(async r=>{try{let d=await s.match(r);if(d){let u=d.headers.get("Content-Length")||d.headers.get("content-length");o.size||(o.size=0),o.size+=parseInt(u||"0",10)}else console.warn(`Service Worker: No matching response found for request in cache '${o.name}':`,r.url)}catch(d){console.error(`Service Worker: Error matching request or getting size for ${r.url}:`,d)}}))).then(()=>{a(0)}).catch(c=>{console.log("Error al obtener informacion del cach\xE9:",c),l(c)})}))),console.log("cacheStats",n),{cacheStats:n}});v.set(23,async e=>(console.log(`Eliminando cach\xE9 "${e.cacheName}" (Enviroment ${e.__enviroment__})...`),await caches.delete(e.cacheName),console.log(`Cach\xE9 "${e.cacheName}" eliminado! (Enviroment ${e.__enviroment__})...`),{ok:1}));v.set(24,async e=>{let t=[e.__enviroment__||"main",e.module||"?"].join("_");console.log("Setting ForceNerwork for routes: ",e.routes);let o=await(await caches.open(t+"_"+I)).keys(),a=new Set;for(let l of o){let s=l.url.split("/")[3];if(s){console.log("buscando request::",s);for(let c of e.routes)if(s.startsWith(c)&&s.endsWith("_updated")){let r=await T(s,t);r.forceNetwork=!0,await S(s,r,t),a.add(c);break}}}return console.log(`ForceNetwork = true for routes: ${[...a].join(", ")} | In ${o.length}`),{ok:1}});
//# sourceMappingURL=sw.js.map
