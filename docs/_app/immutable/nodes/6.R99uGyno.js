import"../chunks/DsnmJJEf.js";import{e as B,g as Z,i as e,h as d,p as ke,f as h,c as g,r as m,s as l,t as Q,u as T,b as _,d as Ae,a as U,x as ge}from"../chunks/Bf0lWsRu.js";import{s as se}from"../chunks/WwA8pLij.js";import{i as E}from"../chunks/D7jGWfSg.js";import{e as le,i as ue}from"../chunks/CA0Nq6W4.js";import{d as Ce}from"../chunks/Cu2BEfFs.js";import{I as ee}from"../chunks/C61KEcBC.js";import{M as he}from"../chunks/03-DSbml.js";import{P as Fe}from"../chunks/Cjl-14FK.js";import"../chunks/D6G-nuyK.js";import{S as Re}from"../chunks/Cipxj451.js";import{S as Le}from"../chunks/CgTtmJH3.js";import{C as ze}from"../chunks/B4jWeLBe.js";import{V as Ve}from"../chunks/9nVZToYO.js";import{t as qe,N as Y,n as ne}from"../chunks/DP6SISrU.js";import{G as Pe,P as Ee,C as W,c as be}from"../chunks/CUNP7WoD.js";import{M as Me}from"../chunks/C6oF-QFB.js";import{s as xe,c as ye}from"../chunks/C7iUW-It.js";import{b as de}from"../chunks/BWVkWQLM.js";import{p as He}from"../chunks/DEnCy23-.js";const we=[{id:1,name:"Gestión"},{id:2,name:"Seguridad"},{id:3,name:"Maestros"},{id:4,name:"Productos"},{id:5,name:"Reportes"}],Oe=[{id:1,name:"Visualizar",short:"VER",icon:"icon-eye",color:"#00c07d",color2:"#49c99c"},{id:2,name:"Editar",short:"EDITAR",icon:"icon-pencil",color:"#0080f9"},{id:3,name:"Eliminar",short:"ELIMINAR",icon:"icon-trash",color:"#0080f9"},{id:7,name:"Todo",short:"EDITAR",icon:"icon-shield",color:"#af12eb",color2:"#d35eff"}];class Be extends Pe{route="seguridad-accesos";useCache={min:5,ver:1};#e=B(Z([]));get accesos(){return e(this.#e)}set accesos(s){d(this.#e,s,!0)}#s=B(Z(new Map));get accesosMap(){return e(this.#s)}set accesosMap(s){d(this.#s,s,!0)}handler(s){this.accesos=s||[],this.accesosMap=new Map(this.accesos.map(i=>[i.id,i]))}constructor(){super(),this.fetch()}updateAcceso(s){const i=this.accesos.find(t=>t.id===s.id);i?Object.assign(i,s):this.accesos.unshift(s),this.accesosMap.set(s.id,s)}removeAcceso(s){this.accesos=this.accesos.filter(i=>i.id!==s),this.accesosMap.delete(s)}}class Je extends Pe{route="perfiles";useCache={min:5,ver:1};#e=B(Z([]));get perfiles(){return e(this.#e)}set perfiles(s){d(this.#e,s,!0)}#s=B(Z(new Map));get perfilesMap(){return e(this.#s)}set perfilesMap(s){d(this.#s,s,!0)}handler(s){const i=(s||[]).filter(t=>t.ss>0);for(const t of i){t.accesos=t.accesos||[],t.accesosMap=t.accesosMap||new Map;for(const R of t.accesos){const L=Math.floor(R/10),v=R-L*10;t.accesosMap.has(L)?t.accesosMap.get(L).push(v):t.accesosMap.set(L,[v])}}this.perfiles=i,this.perfilesMap=new Map(i.map(t=>[t.id,t]))}constructor(){super(),this.fetch()}updatePerfil(s){const i=this.perfiles.find(t=>t.id===s.id);i?Object.assign(i,s):this.perfiles.unshift(s),this.perfilesMap.set(s.id,s)}removePerfil(s){this.perfiles=this.perfiles.filter(i=>i.id!==s),this.perfilesMap.delete(s)}}const Ke=O=>Ee({data:O,route:"seguridad/accesos",refreshRoutes:["seguridad/accesos"]}),Qe=O=>{const s={...O};return delete s.accesosMap,delete s._open,Ee({data:s,route:"perfiles",refreshRoutes:["perfiles"]})};function ve(O,s){return new Map(O.map(i=>[i[s],i]))}var Ue=h('<div class="line-1 p-abs AccesoCard_12m1sa4"></div>'),We=h('<div class="absolute flex items-center justify-center i-edit AccesoCard_12m1sa4" role="button" tabindex="0"><i class="icon-pencil"></i></div> <div class="absolute flex items-center justify-center a-id c-purple AccesoCard_12m1sa4"> </div>',1),Xe=h('<div class="bnc1 AccesoCard_12m1sa4"><i></i></div>'),Ye=h('<div class="accion-btn AccesoCard_12m1sa4" role="button" tabindex="0"> </div>'),Ze=h('<div class="acciones-ac1 AccesoCard_12m1sa4"></div> <div class="acciones-ac2 w-full flex justify-center z-10 AccesoCard_12m1sa4"></div>',1),$e=h('<div role="button" tabindex="0"><div class="mr-4 AccesoCard_12m1sa4"> </div> <!> <!> <!></div>');function es(O,s){ke(s,!0);const i=ve(Oe,"id");let t=He(s,"perfilForm",15);const R=T(()=>t()?.accesosMap?.get(s.acceso.id)||[]),L=T(()=>{if(e(R).length===0||s.isEdit)return;const r=[...e(R)].sort().reverse(),o=i.get(r[0]||0);return o?.color2||o?.color||""});function v(r){if(W.deviceType===1||!t())return;r.stopPropagation();const o=t().accesosMap.get(s.acceso.id)||[];if(o.length>=s.acceso.acciones.length)t().accesosMap.delete(s.acceso.id);else{const p=s.acceso.acciones.filter(C=>!o.includes(C)),k=[...o,p[0]].filter(C=>C);t().accesosMap.set(s.acceso.id,k)}t(t().accesosMap=new Map(t().accesosMap),!0)}function u(r,o){if(r.stopPropagation(),!t())return;let p=[...t().accesosMap.get(s.acceso.id)||[]];p.includes(o)?p=p.filter(k=>k!==o):p.push(o),p.sort((k,C)=>C-k),p.length===0?t().accesosMap.delete(s.acceso.id):t().accesosMap.set(s.acceso.id,p),t(t().accesosMap=new Map(t().accesosMap),!0)}const ae=T(()=>{let r="acceso-card";return s.isEdit&&(r+=" sel"),W.deviceType>1&&(r+=" mobile"),r});var b=$e();b.__click=v,b.__keydown=r=>{(r.key==="Enter"||r.key===" ")&&(r.preventDefault(),v(r))};let re;var $=g(b),te=g($,!0);m($);var oe=l($,2);{var n=r=>{var o=Ue();let p;Q(()=>p=de(o,"",p,{"background-color":e(L)})),_(r,o)};E(oe,r=>{W.deviceType>1&&r(n)})}var P=l(oe,2);{var f=r=>{var o=We(),p=U(o);p.__click=A=>{A.stopPropagation(),s.onEdit()},p.__keydown=A=>{(A.key==="Enter"||A.key===" ")&&(A.preventDefault(),s.onEdit())};var k=l(p,2),C=g(k,!0);m(k),Q(()=>se(C,s.acceso.id)),_(r,o)};E(P,r=>{s.isEdit&&r(f)})}var x=l(P,2);{var y=r=>{var o=Ze(),p=U(o);le(p,21,()=>e(R),ue,(C,A)=>{const I=T(()=>i.get(e(A)));var G=ge(),q=U(G);{var X=J=>{var j=Xe();let D;var K=g(j);m(j),Q(()=>{D=de(j,"",D,{"background-color":e(I).color}),xe(K,1,ye(e(I).icon),"AccesoCard_12m1sa4")}),_(J,j)};E(q,J=>{e(I)&&J(X)})}_(C,G)}),m(p);var k=l(p,2);le(k,21,()=>s.acceso.acciones,ue,(C,A)=>{const I=T(()=>i.get(e(A))),G=T(()=>e(R).includes(e(A)));var q=ge(),X=U(q);{var J=j=>{var D=Ye();D.__click=H=>u(H,e(A)),D.__keydown=H=>{(H.key==="Enter"||H.key===" ")&&(H.preventDefault(),u(H,e(A)))};let K;var ce=g(D,!0);m(D),Q(()=>{K=de(D,"",K,{"background-color":e(G)?e(I).color:void 0,"border-color":e(G)?e(I).color:void 0,color:e(G)?"white":void 0}),se(ce,e(I).short)}),_(j,D)};E(X,j=>{e(I)&&j(J)})}_(C,q)}),m(k),_(r,o)};E(x,r=>{!s.isEdit&&t()&&r(y)})}m(b),Q(()=>{xe(b,1,ye(e(ae)),"AccesoCard_12m1sa4"),re=de(b,"",re,{"border-left-color":e(L)}),se(te,s.acceso.nombre)}),_(O,b),Ae()}Ce(["click","keydown"]);var ss=h('<span class="c-red">(Modo Edición)</span>'),as=h('<span class="mr-4">:</span> <span class="c-purple ml-4"> </span>',1),rs=h('<button class="bx-green mr-8" aria-label="Agregar acceso"><i class="icon-plus"></i></button>'),ts=h('<button class="bx-blue mr-8" aria-label="Guardar"><i class="icon-floppy"></i> <span class="max-md:hidden">Guardar</span></button>'),os=h('<i class="c-red icon-cancel"></i>'),cs=h('<i class="icon-pencil"></i>'),is=h('<button class="bn-white" aria-label="Editar"><!></button>'),ns=h('<div class="mb-8 px-12 py-8 bg-red-100 border border-red-400 text-red-700 rounded w-fit">Debe seleccionar un perfil para editar sus accesos.</div>'),ds=h('<div class="ff-bold h3 mb-6"> </div> <div class="grid grid-cols-3 gap-x-12 gap-y-8 mb-16"></div>',1),ls=h('<div class="grid grid-cols-24 gap-10 p-6"><!> <!> <!> <!> <!> <div class="col-span-24 flex items-center gap-12 mb-4"><div class="h-[1px] grow bg-gray-300"></div> <div class="ff-bold text-lg">Acciones</div> <div class="h-[1px] grow bg-gray-300"></div></div> <!></div>'),us=h('<div class="grid grid-cols-24 gap-10 p-6"><!> <!></div>'),vs=h('<div class="flex justify-between h-full gap-8 max-md:flex-col"><div class="w-full md:w-[32%]"><div class="flex justify-between items-center w-full mb-10"><div class="i-search mr-16 w-256"><div><i class="icon-search"></i></div> <input class="w-full" autocomplete="off" type="text"/></div> <div class="flex items-center"><button class="bx-green" aria-label="Agregar perfil"><i class="icon-plus"></i></button></div></div> <!></div> <div class="w-full md:w-[66.5%]"><div class="flex justify-between w-full mb-6"><div class="ff-bold text-xl"><span>Accesos</span> <!> <!></div> <div class="flex items-center max-md:absolute max-md:top-0 max-md:right-0"><!> <!> <!></div></div> <!> <!></div></div> <!> <!>',1);function Ns(O,s){ke(s,!0);const i=new Be,t=new Je,R=ve(we,"id"),L=ve(Me,"id");let v=B(Z({})),u=B(Z({})),ae=B(""),b=B(!1);const re=T(()=>{const n=new Map;for(let f of i.accesos)for(let x of f.modulosIDs){const y=[x,f.grupo].join("_");n.has(y)||n.set(y,[]),n.get(y).push(f);break}const P=[];for(let[f,x]of n){const[y,r]=f.split("_").map(o=>parseInt(o));P.push({moduleID:y,group:r,accesos:x,groupName:R.get(r)?.name||"",moduleName:L.get(y)?.name||""})}return P});async function $(){const n=e(v);if(!n.nombre||!n.orden||(n.acciones?.length||0)==0||!n.grupo||(n.modulosIDs?.length||0)===0){Y.failure("Faltan propiedades para agregar el acceso.");return}ne.Loading.standard("Actualizando Acceso...");try{const P=await Ke(n);(n.id||0)<=0&&(n.id=P.id),i.updateAcceso(n),d(v,{},!0),be(1),Y.success("Acceso guardado correctamente")}catch(P){Y.failure(P)}ne.Loading.remove()}async function te(n,P){const f=e(u);if(!f.nombre){Y.failure("Faltan propiedades para agregar el perfil.");return}if(P){f.accesos=[];for(let[r,o]of f.accesosMap){o.length===0&&f.accesosMap.delete(r);for(let p of o)f.accesos.push(r*10+p)}const x=i.accesos.filter(r=>f.accesosMap.has(r.id)),y=new Set;for(let r of x)for(let o of r.modulosIDs)y.add(o);f.modulosIDs=[...y]}ne.Loading.standard("Actualizando Perfil...");try{const x=await Qe(f);(f.id||0)<=0&&(f.id=x.id),f._open=!1,t.updatePerfil(f),d(u,{},!0),be(2),Y.success("Perfil guardado correctamente")}catch(x){Y.failure(x)}ne.Loading.remove()}const oe=[{header:"ID",headerCss:"w-54",cellCss:"text-center c-purple",getValue:n=>n.id},{header:"Perfil",highlight:!0,getValue:n=>n.nombre},{header:"...",headerCss:"w-42",cellCss:"text-center",id:"actions",buttonEditHandler:n=>{d(u,{...n,accesosMap:new Map(n.accesosMap)},!0),d(b,!1),W.openModal(2)}}];Fe(O,{title:"Perfiles & Accesos",children:(n,P)=>{var f=vs(),x=U(f),y=g(x),r=g(y),o=g(r),p=l(g(o),2);p.__keyup=a=>{a.stopPropagation(),qe(()=>{d(ae,(a.target.value||"").toLowerCase().trim(),!0)},150)},m(o);var k=l(o,2),C=g(k);C.__click=a=>{a.stopPropagation(),d(u,{ss:1,accesosMap:new Map},!0),W.openModal(2)},m(k),m(r);var A=l(r,2);Ve(A,{css:"w-full selectable",get columns(){return oe},maxHeight:"calc(100vh - 8rem - 16px)",get data(){return t.perfiles},get selected(){return e(u).id},get filterText(){return e(ae)},getFilterContent:a=>[a.nombre].filter(c=>c).join(" ").toLowerCase(),isSelected:(a,c)=>a.id===c,onRowClick:a=>{d(b,!1),a.id===e(u).id?d(u,{},!0):d(u,{...a,_open:!0,accesosMap:new Map(a.accesosMap)},!0)}}),m(y);var I=l(y,2),G=g(I),q=g(G),X=l(g(q),2);{var J=a=>{var c=ss();_(a,c)};E(X,a=>{e(b)&&a(J)})}var j=l(X,2);{var D=a=>{var c=as(),w=l(U(c),2),z=g(w,!0);m(w),Q(()=>se(z,e(u).nombre)),_(a,c)};E(j,a=>{e(u).id>0&&a(D)})}m(q);var K=l(q,2),ce=g(K);{var H=a=>{var c=rs();c.__click=w=>{w.stopPropagation(),d(v,{ss:1,modulosIDs:[],acciones:[],id:0,nombre:"",orden:0,grupo:0,upd:0},!0),W.openModal(1)},_(a,c)};E(ce,a=>{e(b)&&a(H)})}var pe=l(ce,2);{var Ie=a=>{var c=ts();c.__click=w=>{w.stopPropagation(),te(!1,!0)},_(a,c)};E(pe,a=>{e(u).id>0&&a(Ie)})}var De=l(pe,2);{var Se=a=>{var c=is();c.__click=M=>{M.stopPropagation(),d(b,!e(b))};var w=g(c);{var z=M=>{var F=os();_(M,F)},S=M=>{var F=cs();_(M,F)};E(w,M=>{e(b)?M(z):M(S,!1)})}m(c),_(a,c)};E(De,a=>{e(u).id||a(Se)})}m(K),m(G);var fe=l(G,2);{var Ne=a=>{var c=ns();_(a,c)};E(fe,a=>{!e(b)&&!e(u).id&&a(Ne)})}var Te=l(fe,2);le(Te,17,()=>e(re),ue,(a,c)=>{var w=ds(),z=U(w),S=g(z);m(z);var M=l(z,2);le(M,21,()=>e(c).accesos,ue,(F,V)=>{es(F,{get acceso(){return e(V)},get isEdit(){return e(b)},onEdit:()=>{d(v,{...e(V)},!0),W.openModal(1)},get perfilForm(){return e(u)},set perfilForm(ie){d(u,ie,!0)}})}),m(M),Q(()=>se(S,`${e(c).moduleName??""}${e(c).moduleName?" > ":""}${e(c).groupName??""}`)),_(a,w)}),m(I),m(x);var me=l(x,2);{let a=T(()=>(e(v)?.id>0?"Editando":"Creando")+" Acceso"),c=T(()=>!!e(v)?.id);he(me,{id:1,size:6,get title(){return e(a)},get isEdit(){return e(c)},onSave:()=>$(),children:(w,z)=>{var S=ls(),M=g(S);ee(M,{save:"nombre",css:"col-span-14",label:"Nombre",required:!0,get saveOn(){return e(v)},set saveOn(N){d(v,N,!0)}});var F=l(M,2);Le(F,{save:"grupo",css:"col-span-10",label:"Grupo",required:!0,get options(){return we},keyId:"id",keyName:"name",get saveOn(){return e(v)},set saveOn(N){d(v,N,!0)}});var V=l(F,2);ee(V,{save:"descripcion",css:"col-span-16",label:"Descripción",get saveOn(){return e(v)},set saveOn(N){d(v,N,!0)}});var ie=l(V,2);ee(ie,{save:"orden",css:"col-span-8",label:"Orden",type:"number",get saveOn(){return e(v)},set saveOn(N){d(v,N,!0)}});var _e=l(ie,2);Re(_e,{save:"modulosIDs",css:"col-span-24",label:"Módulos",get options(){return Me},keyId:"id",keyName:"name",get saveOn(){return e(v)},set saveOn(N){d(v,N,!0)}});var je=l(_e,4);ze(je,{save:"acciones",css:"col-span-24 flex-wrap gap-y-8",get options(){return Oe},keyId:"id",keyName:"name",type:"multiple",get saveOn(){return e(v)},set saveOn(N){d(v,N,!0)}}),m(S),_(w,S)},$$slots:{default:!0}})}var Ge=l(me,2);{let a=T(()=>(e(u)?.id>0?"Editando":"Creando")+" Perfil"),c=T(()=>!!e(u)?.id);he(Ge,{id:2,size:5,get title(){return e(a)},get isEdit(){return e(c)},onSave:()=>te(),onClose:()=>{d(u,{},!0)},children:(w,z)=>{var S=us(),M=g(S);ee(M,{save:"nombre",css:"col-span-24",label:"Nombre",required:!0,get saveOn(){return e(u)},set saveOn(V){d(u,V,!0)}});var F=l(M,2);ee(F,{save:"descripcion",css:"col-span-24",label:"Descripción",get saveOn(){return e(u)},set saveOn(V){d(u,V,!0)}}),m(S),_(w,S)},$$slots:{default:!0}})}_(n,f)},$$slots:{default:!0}}),Ae()}Ce(["keyup","click"]);export{Ns as component};
