import{d as dt,t as k,i as s,u as at,c as C,a as it}from"./web-B9EQUxsk.js";import{a as w,d as z,e as X,c as m,f as st,b as G,F as ct,S as J}from"./solid-DoXAfIeo.js";import{S as ut,C as ft,d as vt,P as _t,m as pt}from"./app-B5TM_Vz_.js";import{j as mt,P as rt,k as gt,l as Y,b as et,n as nt,L as Z,t as bt,h as kt}from"./main-wawJI9OC.js";import{u as St,g as ht}from"./productos-C72cI8By.js";import{u as $t}from"./sedes-almacenes-Hi_XM9WT.js";import{a as yt,I as Pt,b as W}from"./Input-BqvI6aOu.js";import{Q as wt}from"./QTable-XC_BfQM2.js";import"./main-B_drbOPO.js";import"./http-C6Eur1sL.js";import"./store-DHPf-lLy.js";const xt="_card_venta_we406_1",Ct="_card_venta_nombre_we406_16",It="_card_venta_nombre_line_we406_29",Dt="_card_venta_producto_we406_40",Ut="_card_venta_producto_ctn_we406_44",Mt="_buttons_cantidad_we406_48",Tt="_button_venta_cantidad_we406_57",Vt="_input_cantidad_we406_75",At="_producto_sku_we406_97",I={card_venta:xt,card_venta_nombre:Ct,card_venta_nombre_line:It,card_venta_producto:Dt,card_venta_producto_ctn:Ut,buttons_cantidad:Mt,button_venta_cantidad:Tt,input_cantidad:Vt,producto_sku:At};var Lt=k('<div class="jc-between mb-06 mr-16"><div class=flex><div class="search-c4 mr-16 w14rem"><div><i class=icon-search></i></div><input class=w100 autocomplete=off type=text></div></div><div class="flex jc-between w100"><div class=mr-auto></div></div><div>'),Nt=k('<div class="side-layer1 grow-1 px-12 py-08"><div class="flex ai-center jc-between w100 mb-12"><div class="ff-bold h3 mb-04">DETALLE DE VENTA</div><div class="flex ai-center"><button class="bn1 b-blue">Guardar<i class=icon-floppy></i></button></div></div><div class="w100-10 flex-wrap">'),Et=k('<div class="box-error-ms mb-08">'),Kt=k("<div> "),jt=k("<span class=ml-04>(<!>)"),Ft=k("<span>"),Bt=k('<button class="bn1 s5 b-red"><i class=icon-trash>'),ot=k("<div>"),zt=k('<div class="ml-04 mr-04">|'),Gt=k('<div class="ff-bold c-purple2">'),Rt=k('<div class="ff-bold ml-04 c-purple2">(SKU)'),Ht=k('<div class="flex ai-center">'),Ot=k('<div class="flex-wrap z20 p-rel">'),Qt=k('<div class="px-04 py-02"><div><div><div></div></div><div class="w100 grid ai-center"><div><div></div></div><div><input type=number value class="ff-mono w100"><div class=ml-04>/</div></div><div class="ff-mono t-r"></div><div class="ff-mono t-r">');const[tt,qt]=w(null);function le(){const[a,T]=w([]),[S]=St(),[h]=$t(),[g,E]=w({}),[i,p]=w(""),[f,$]=w(-1),[V,x]=w(-1),[A,D]=w(""),[y,K]=w([]);let L;const j=z(()=>mt(y(),"key")),r=async t=>{let n=[];Z.standard("Obteniendo Registros...");try{n=await ht(t)}catch{Z.remove();return}console.log("productos stock::",n),T(n),rt.setValue("almacen_id",t),Z.remove()};X(()=>{if(V()==-1&&h()?.Almacenes?.length>0){g();let t=rt.getValueInt("almacen_id")||0;t||(t=h().Almacenes[0].ID),x(t),r(t)}});const[U,P]=w([]),[M,R]=w([]);X(()=>{const t=gt(a(),"ProductoID");console.log("productos stock map::",a(),t);const n=[];for(let o of S()?.productos||[]){const c=t.get(o.ID)||[];if(c.length===0)continue;const l={producto:o,cant:0,key:`P${o.ID}`,searchText:o.Nombre.toLowerCase()},d=[],v=[];for(let u of c)u.SKU?d.push(u):v.push(u);if(d.length>0){const u={...l,skus:d,key:`K${o.ID}`};for(let e of d)u.cant+=e.Cantidad;n.push(u)}if(v.length>0){let u;o.SbnCantidad>1&&(u={...l,key:`S${o.ID}`},u.isSubUnidad=!0,u.cant=o.SbnCantidad);for(let e of v)l.cant+=e.Cantidad;n.push(l),u&&n.push(u)}}console.log("productos parsed::",n),P(n),R(n)});const H="abcdefghijklmnopqrstuvwxyz",F="123456789";let N="";const O=t=>{t===i()||t===N||(console.log("buscando:: ",t),N=t,bt(()=>{const n=t.toLowerCase().split(" "),o=[];for(let c of M())kt(c.searchText,n)&&o.push(c);console.log("filtrados::",o),P(o),p(t),$(-1)},80))},B=(t,n,o)=>{const c=j().get(t.key)?.cantidad||0;if(t.cant-c<n){D(`No hay suficiente stock de "${t.producto.Nombre}" para agregar ${n} unidades.`);return}console.log("producto venta::",t);const d=y().find(e=>e.key===t.key);if(d){if(d.cantidad+=n,o){const e=d.skus.get(o);if(e){const _=t.skus.find(b=>b.SKU===o)?.Cantidad||0;if(e>=_){D(`El SKU ${o} del producto "${t.producto.Nombre}" sólo posee ${_} unidad(es).`);return}d.skus.set(o,e+1)}else d.skus.set(o,1)}}else y().push({key:t.key,cantidad:n,productoID:t.producto.ID,skus:new Map(o?[[o,1]]:[]),isSubUnidad:t.isSubUnidad||!1});const v=[...y()];console.log("venta productos::",v),K(v);const u=tt();u&&(u.value=""),L&&(L.value=""),p(""),P([...M()]),$(-1)},Q=t=>{console.log("recalculando::",t);const n={...g(),total:0,subtotal:0,igv:0};for(let o of t){const l=S().productosMap.get(o.productoID).PrecioFinal*o.cantidad;n.total+=l}n.subtotal=Math.floor(n.total/1.18),n.igv=n.total-n.subtotal,E(n)};return X(st(()=>y(),()=>{Q(y())})),m(_t,{title:"Ventas",class:"flex",get children(){return[(()=>{var t=Lt(),n=t.firstChild,o=n.firstChild,c=o.firstChild,l=c.nextSibling,d=n.nextSibling;d.firstChild;var v=d.nextSibling;t.style.setProperty("width","48%"),s(n,m(ut,{css:"w16rem s6 mb-02 mr-12",label:"",keys:"ID.Nombre",get options(){return h()?.Almacenes||[]},placeholder:" ALMACÉN",get selected(){return V()},onChange:e=>{if(x(e?.ID||-1),e){r(e.ID);return}}}),o),l.$$keydown=e=>{if(e.stopPropagation(),A()?.length>0&&D(""),console.log(e.key),e.key==="ArrowUp"){const _=f()-1;if(_<-1)return;$(_)}else if(e.key==="ArrowDown")$(f()+1);else if(e.key==="Enter"&&f()>=0){const _=tt(),b=parseInt(_.value||"0")||1,q=U()[f()];if(q.skus?.length>0){D("Debe seleccionar 1 SKU.");return}B(q,b)}else{const _=e.key.toLocaleLowerCase();if(f()>=0&&(F.includes(_)||e.key==="Backspace")){const b=tt();console.log("key backspace:: ",b.value),b&&(e.key==="Backspace"?b.value&&(b.value="",e.preventDefault()):(b.value+=_,e.preventDefault()))}else(H.includes(_)||F.includes(_))&&O(N+e.key)}},l.addEventListener("keypress",()=>!1),l.$$keyup=e=>{e.stopPropagation();const _=(e.target.value||"").toLowerCase().trim();O(_)};var u=L;return typeof u=="function"?at(u,l):L=l,s(d,m(yt,{label:"Buscar SKU"}),null),v.style.setProperty("height","calc(100% - 12px - 4.2rem)"),v.style.setProperty("position","relative"),s(v,m(ft,{get data(){return U()},render:(e,_)=>{console.log("card rerender:: ",_,e);const b=()=>_===f();return m(Wt,{idx:_,get isSelected(){return b()},get ventasProductosMap(){return j()},productoStock:e,agregarProductoVenta:(q,lt)=>{B(e,q,lt)},setProductoSelected:$,get filterText(){return i()},onmouseover:()=>{f()>=0&&$(-1)}})}})),G(()=>t.classList.toggle("column",!![2,3].includes(vt()))),t})(),(()=>{var t=Nt(),n=t.firstChild,o=n.nextSibling;return t.style.setProperty("width","calc(var(--page-width) * 0.52)"),s(t,(()=>{var c=z(()=>!!A());return()=>c()&&(()=>{var l=Et();return s(l,A),l})()})(),n),s(o,m(Pt,{label:"Cliente",css:"w-06x",get saveOn(){return g()},save:"clienteID"}),null),s(o,m(W,{label:"Código",css:"w-05x"}),null),s(o,m(W,{label:"Sub Total",css:"ff-mono w-045x",getContent:()=>Y(g().subtotal)}),null),s(o,m(W,{label:"IGV",css:"ff-mono w-04x",getContent:()=>Y(g().igv)}),null),s(o,m(W,{label:"Total",css:"ff-mono w-045x",get content(){return g().total},getContent:()=>Y(g().total)}),null),s(t,m(wt,{get data(){return y()},css:"w100 mt-12 w-page-t",tableCss:"w100",maxHeight:"calc(100vh - 12rem - 12px)",columns:[{header:"Nº",getValue:(c,l)=>String(l+1)},{header:"Producto",render:c=>{const l=S().productosMap.get(c.productoID);let d=l?.Nombre||"";return c.isSubUnidad&&(d=`${l.SbnUnidad} de ${d}`),d}},{header:"SKU",render:c=>(console.log("skuss",c),c.skus?z(()=>[...c.skus].map(([l,d])=>(()=>{var v=Kt(),u=v.firstChild;return s(v,l,u),s(v,d>1?(()=>{var e=jt(),_=e.firstChild,b=_.nextSibling;return b.nextSibling,s(e,d,b),e})():null,null),v})())):"")},{header:"Cantidad",render:c=>et(c.cantidad)},{header:"Monto",css:"ff-mono t-r",render:c=>{const d=S().productosMap.get(c.productoID).PrecioFinal*c.cantidad;return(()=>{var v=Ft();return s(v,()=>et(d/100,2)),v})()}},{header:"...",headerStyle:{width:"2rem"},cellStyle:{padding:"0 4px"},render:c=>(()=>{var l=Bt();return l.$$click=d=>{d.stopPropagation();const v=y().filter(u=>u.key!==c.key);K(v)},l})()}]}),null),t})()]}})}function Jt(a){const T=[2,3,4,5,6,8,10,12];return(()=>{var S=ot();return s(S,m(ct,{each:T,children:h=>(()=>{var g=ot();return g.$$click=E=>{E.stopPropagation(),a.onSelect(h)},s(g,h),G(()=>C(g,`flex-center ff-bold ${I.button_venta_cantidad}`)),g})()})),G(()=>C(S,["flex p-rel ai-end h100",I.buttons_cantidad].join(" "))),S})()}const Wt=a=>{let T;X(st(()=>a.isSelected,()=>{a.isSelected&&qt(T)}));const S=()=>{const i=pt(a.productoStock.producto.Nombre,a.filterText);return a.productoStock.isSubUnidad||a.productoStock.skus?.length>0?(()=>{var p=Ht();return s(p,i,null),s(p,m(J,{get when(){return a.productoStock.isSubUnidad},get children(){return[zt(),(()=>{var f=Gt();return s(f,()=>a.productoStock.producto.SbnUnidad),f})()]}}),null),s(p,m(J,{get when(){return!a.productoStock.isSubUnidad},get children(){return Rt()}}),null),p})():i},h=()=>a.productoStock.skus?.length>0,g=z(()=>{const i=a.productoStock.key;let p=a.ventasProductosMap.get(i)?.cantidad||0;if(i[0]==="P"){const f=`S${i.slice(1)}`,$=a.ventasProductosMap.get(f)?.cantidad||0;if($>0){const V=a.productoStock.producto;p=p+Math.ceil($/V.SbnCantidad)}}return a.productoStock.cant-p}),E=z(()=>{let i=a.productoStock.skus||[];const p=a.ventasProductosMap.get(a.productoStock.key);return p?.skus?.size>0&&(i=i.filter(f=>p.skus.has(f.SKU)?f.Cantidad>p.skus.get(f.SKU):!0)),i.length>4&&(i=i.slice(0,4)),i});return(()=>{var i=Qt(),p=i.firstChild,f=p.firstChild,$=f.firstChild,V=f.nextSibling,x=V.firstChild,A=x.firstChild,D=x.nextSibling,y=D.firstChild,K=D.nextSibling,L=K.nextSibling;i.$$mouseover=r=>{r.stopPropagation(),a.onmouseover()},p.$$click=()=>{a.setProductoSelected(a.idx)},s(f,S,null),V.style.setProperty("grid-template-columns","1fr 3.8rem 2.8rem 5rem"),s(A,S),s(x,m(J,{get when(){return h()},get children(){var r=Ot();return r.style.setProperty("margin","0 -3px"),s(r,m(ct,{get each(){return E()},children:U=>(()=>{var P=ot();return P.$$click=M=>{M.stopPropagation(),a.agregarProductoVenta(1,U.SKU)},s(P,()=>U.SKU),G(()=>C(P,`h5 ${I.producto_sku}`)),P})()})),r}}),null),s(x,m(J,{get when(){return!h()},get children(){return m(Jt,{onSelect:r=>{a.agregarProductoVenta(r)}})}}),null);var j=T;return typeof j=="function"?at(j,y):T=y,s(K,g),s(L,()=>et(a.productoStock.producto.PrecioFinal/100,2)),G(r=>{var U=!!a.isSelected,P=!!h(),M=a.idx===0?"8px":void 0,R=nt("flex p-rel jc-between",I.card_venta),H=I.card_venta_nombre,F=I.card_venta_nombre_line,N=`h100 ${I.card_venta_producto_ctn}`,O={"flex ai-center":!h()},B=`${I.card_venta_producto}`,Q=nt("p-rel flex ai-center",I.input_cantidad);return U!==r.e&&i.classList.toggle("sld",r.e=U),P!==r.t&&i.classList.toggle("sku",r.t=P),M!==r.a&&((r.a=M)!=null?i.style.setProperty("margin-top",M):i.style.removeProperty("margin-top")),R!==r.o&&C(p,r.o=R),H!==r.i&&C(f,r.i=H),F!==r.n&&C($,r.n=F),N!==r.s&&C(x,r.s=N),r.h=it(x,O,r.h),B!==r.r&&C(A,r.r=B),Q!==r.d&&C(D,r.d=Q),r},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0}),i})()};dt(["keyup","keydown","click","mouseover"]);export{le as default};
