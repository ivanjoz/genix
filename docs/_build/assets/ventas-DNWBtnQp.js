import{a as P,f as z,g as X,c as g,d as dt,i as s,b as G,F as at,S as J,t as k,o as st,u as ct,e as C,h as it}from"./web-D2t8vN-4.js";import{S as ut,o as vt,q as ft,I as _t,r as W,v as Y,a as et,P as pt,w as gt,L as Z,x as nt,y as mt,t as bt,z as kt,e as St,A as ht,B as rt}from"./app-De9iPHfG.js";import{u as $t,g as yt}from"./productos-DeQ_l2vI.js";import{u as wt}from"./sedes-almacenes-PyW2IIXn.js";import{Q as Pt}from"./QTable-CpfVE6kU.js";const xt="_card_venta_we406_1",Ct="_card_venta_nombre_we406_16",It="_card_venta_nombre_line_we406_29",Dt="_card_venta_producto_we406_40",Ut="_card_venta_producto_ctn_we406_44",Mt="_buttons_cantidad_we406_48",At="_button_venta_cantidad_we406_57",Tt="_input_cantidad_we406_75",Vt="_producto_sku_we406_97",I={card_venta:xt,card_venta_nombre:Ct,card_venta_nombre_line:It,card_venta_producto:Dt,card_venta_producto_ctn:Ut,buttons_cantidad:Mt,button_venta_cantidad:At,input_cantidad:Tt,producto_sku:Vt};var Lt=k('<div class="jc-between mb-06 mr-16"><div class=flex><div class="search-c4 mr-16 w14rem"><div><i class=icon-search></i></div><input class=w100 autocomplete=off type=text></div></div><div class="flex jc-between w100"><div class=mr-auto></div></div><div>'),Nt=k('<div class="side-layer1 grow-1 px-12 py-08"><div class="flex ai-center jc-between w100 mb-12"><div class="ff-bold h3 mb-04">DETALLE DE VENTA</div><div class="flex ai-center"><button class="bn1 b-blue">Guardar<i class=icon-floppy></i></button></div></div><div class="w100-10 flex-wrap">'),Et=k('<div class="box-error-ms mb-08">'),Kt=k("<div> "),Ft=k("<span class=ml-04>(<!>)"),jt=k("<span>"),Bt=k('<button class="bn1 s5 b-red"><i class=icon-trash>'),ot=k("<div>"),zt=k('<div class="ml-04 mr-04">|'),Gt=k('<div class="ff-bold c-purple2">'),Rt=k('<div class="ff-bold ml-04 c-purple2">(SKU)'),qt=k('<div class="flex ai-center">'),Ht=k('<div class="flex-wrap z20 p-rel">'),Ot=k('<div class="px-04 py-02"><div><div><div></div></div><div class="w100 grid ai-center"><div><div></div></div><div><input type=number value=""class="ff-mono w100"><div class=ml-04>/</div></div><div class="ff-mono t-r"></div><div class="ff-mono t-r">');const[tt,Qt]=P(null);function oe(){const[a,A]=P([]),[S]=$t(),[h]=wt(),[m,E]=P({}),[i,p]=P(""),[v,$]=P(-1),[T,x]=P(-1),[V,D]=P(""),[y,K]=P([]);let L;const F=z(()=>gt(y(),"key")),n=async t=>{let r=[];Z.standard("Obteniendo Registros...");try{r=await yt(t)}catch{Z.remove();return}console.log("productos stock::",r),A(r),nt.setValue("almacen_id",t),Z.remove()};X(()=>{if(T()==-1&&h()?.Almacenes?.length>0){m();let t=nt.getValueInt("almacen_id")||0;t||(t=h().Almacenes[0].ID),x(t),n(t)}});const[U,w]=P([]),[M,R]=P([]);X(()=>{const t=mt(a(),"ProductoID");console.log("productos stock map::",a(),t);const r=[];for(let o of S()?.productos||[]){const c=t.get(o.ID)||[];if(c.length===0)continue;const l={producto:o,cant:0,key:`P${o.ID}`,searchText:o.Nombre.toLowerCase()},d=[],f=[];for(let u of c)u.SKU?d.push(u):f.push(u);if(d.length>0){const u={...l,skus:d,key:`K${o.ID}`};for(let e of d)u.cant+=e.Cantidad;r.push(u)}if(f.length>0){let u;o.SbnCantidad>1&&(u={...l,key:`S${o.ID}`},u.isSubUnidad=!0,u.cant=o.SbnCantidad);for(let e of f)l.cant+=e.Cantidad;r.push(l),u&&r.push(u)}}console.log("productos parsed::",r),w(r),R(r)});const q="abcdefghijklmnopqrstuvwxyz",j="123456789";let N="";const H=t=>{t===i()||t===N||(console.log("buscando:: ",t),N=t,bt(()=>{const r=t.toLowerCase().split(" "),o=[];for(let c of M())kt(c.searchText,r)&&o.push(c);console.log("filtrados::",o),w(o),p(t),$(-1)},80))},B=(t,r,o)=>{const c=F().get(t.key)?.cantidad||0;if(t.cant-c<r){D(`No hay suficiente stock de "${t.producto.Nombre}" para agregar ${r} unidades.`);return}console.log("producto venta::",t);const d=y().find(e=>e.key===t.key);if(d){if(d.cantidad+=r,o){const e=d.skus.get(o);if(e){const _=t.skus.find(b=>b.SKU===o)?.Cantidad||0;if(e>=_){D(`El SKU ${o} del producto "${t.producto.Nombre}" sólo posee ${_} unidad(es).`);return}d.skus.set(o,e+1)}else d.skus.set(o,1)}}else y().push({key:t.key,cantidad:r,productoID:t.producto.ID,skus:new Map(o?[[o,1]]:[]),isSubUnidad:t.isSubUnidad||!1});const f=[...y()];console.log("venta productos::",f),K(f);const u=tt();u&&(u.value=""),L&&(L.value=""),p(""),w([...M()]),$(-1)},O=t=>{console.log("recalculando::",t);const r={...m(),total:0,subtotal:0,igv:0};for(let o of t){const l=S().productosMap.get(o.productoID).PrecioFinal*o.cantidad;r.total+=l}r.subtotal=Math.floor(r.total/1.18),r.igv=r.total-r.subtotal,E(r)};return X(st(()=>y(),()=>{O(y())})),g(pt,{title:"Ventas",class:"flex",get children(){return[(()=>{var t=Lt(),r=t.firstChild,o=r.firstChild,c=o.firstChild,l=c.nextSibling,d=r.nextSibling;d.firstChild;var f=d.nextSibling;t.style.setProperty("width","48%"),s(r,g(ut,{css:"w16rem s6 mb-02 mr-12",label:"",keys:"ID.Nombre",get options(){return h()?.Almacenes||[]},placeholder:" ALMACÉN",get selected(){return T()},onChange:e=>{if(x(e?.ID||-1),e){n(e.ID);return}}}),o),l.$$keydown=e=>{if(e.stopPropagation(),V()?.length>0&&D(""),console.log(e.key),e.key==="ArrowUp"){const _=v()-1;if(_<-1)return;$(_)}else if(e.key==="ArrowDown")$(v()+1);else if(e.key==="Enter"&&v()>=0){const _=tt(),b=parseInt(_.value||"0")||1,Q=U()[v()];if(Q.skus?.length>0){D("Debe seleccionar 1 SKU.");return}B(Q,b)}else{const _=e.key.toLocaleLowerCase();if(v()>=0&&(j.includes(_)||e.key==="Backspace")){const b=tt();console.log("key backspace:: ",b.value),b&&(e.key==="Backspace"?b.value&&(b.value="",e.preventDefault()):(b.value+=_,e.preventDefault()))}else(q.includes(_)||j.includes(_))&&H(N+e.key)}},l.addEventListener("keypress",()=>!1),l.$$keyup=e=>{e.stopPropagation();const _=(e.target.value||"").toLowerCase().trim();H(_)};var u=L;return typeof u=="function"?ct(u,l):L=l,s(d,g(vt,{label:"Buscar SKU"}),null),f.style.setProperty("height","calc(100% - 12px - 4.2rem)"),f.style.setProperty("position","relative"),s(f,g(ft,{get data(){return U()},render:(e,_)=>{console.log("card rerender:: ",_,e);const b=()=>_===v();return g(Wt,{idx:_,get isSelected(){return b()},get ventasProductosMap(){return F()},productoStock:e,agregarProductoVenta:(Q,lt)=>{B(e,Q,lt)},setProductoSelected:$,get filterText(){return i()},onmouseover:()=>{v()>=0&&$(-1)}})}})),G(()=>t.classList.toggle("column",!![2,3].includes(St()))),t})(),(()=>{var t=Nt(),r=t.firstChild,o=r.nextSibling;return t.style.setProperty("width","calc(var(--page-width) * 0.52)"),s(t,(()=>{var c=z(()=>!!V());return()=>c()&&(()=>{var l=Et();return s(l,V),l})()})(),r),s(o,g(_t,{label:"Cliente",css:"w-06x",get saveOn(){return m()},save:"clienteID"}),null),s(o,g(W,{label:"Código",css:"w-05x"}),null),s(o,g(W,{label:"Sub Total",css:"ff-mono w-045x",getContent:()=>Y(m().subtotal)}),null),s(o,g(W,{label:"IGV",css:"ff-mono w-04x",getContent:()=>Y(m().igv)}),null),s(o,g(W,{label:"Total",css:"ff-mono w-045x",get content(){return m().total},getContent:()=>Y(m().total)}),null),s(t,g(Pt,{get data(){return y()},css:"w100 mt-12",tableCss:"w-page-t w100",maxHeight:"calc(100vh - 12rem - 12px)",columns:[{header:"Nº",getValue:(c,l)=>String(l+1)},{header:"Producto",render:c=>{const l=S().productosMap.get(c.productoID);let d=l?.Nombre||"";return c.isSubUnidad&&(d=`${l.SbnUnidad} de ${d}`),d}},{header:"SKU",render:c=>(console.log("skuss",c),c.skus?z(()=>[...c.skus].map(([l,d])=>(()=>{var f=Kt(),u=f.firstChild;return s(f,l,u),s(f,d>1?(()=>{var e=Ft(),_=e.firstChild,b=_.nextSibling;return b.nextSibling,s(e,d,b),e})():null,null),f})())):"")},{header:"Cantidad",render:c=>et(c.cantidad)},{header:"Monto",css:"ff-mono t-r",render:c=>{const d=S().productosMap.get(c.productoID).PrecioFinal*c.cantidad;return(()=>{var f=jt();return s(f,()=>et(d/100,2)),f})()}},{header:"...",headerStyle:{width:"2rem"},cellStyle:{padding:"0 4px"},render:c=>(()=>{var l=Bt();return l.$$click=d=>{d.stopPropagation();const f=y().filter(u=>u.key!==c.key);K(f)},l})()}]}),null),t})()]}})}function Jt(a){const A=[2,3,4,5,6,8,10,12];return(()=>{var S=ot();return s(S,g(at,{each:A,children:h=>(()=>{var m=ot();return m.$$click=E=>{E.stopPropagation(),a.onSelect(h)},s(m,h),G(()=>C(m,`flex-center ff-bold ${I.button_venta_cantidad}`)),m})()})),G(()=>C(S,["flex p-rel ai-end h100",I.buttons_cantidad].join(" "))),S})()}const Wt=a=>{let A;X(st(()=>a.isSelected,()=>{a.isSelected&&Qt(A)}));const S=()=>{const i=ht(a.productoStock.producto.Nombre,a.filterText);return a.productoStock.isSubUnidad||a.productoStock.skus?.length>0?(()=>{var p=qt();return s(p,i,null),s(p,g(J,{get when(){return a.productoStock.isSubUnidad},get children(){return[zt(),(()=>{var v=Gt();return s(v,()=>a.productoStock.producto.SbnUnidad),v})()]}}),null),s(p,g(J,{get when(){return!a.productoStock.isSubUnidad},get children(){return Rt()}}),null),p})():i},h=()=>a.productoStock.skus?.length>0,m=z(()=>{const i=a.productoStock.key;let p=a.ventasProductosMap.get(i)?.cantidad||0;if(i[0]==="P"){const v=`S${i.slice(1)}`,$=a.ventasProductosMap.get(v)?.cantidad||0;if($>0){const T=a.productoStock.producto;p=p+Math.ceil($/T.SbnCantidad)}}return a.productoStock.cant-p}),E=z(()=>{let i=a.productoStock.skus||[];const p=a.ventasProductosMap.get(a.productoStock.key);return p?.skus?.size>0&&(i=i.filter(v=>p.skus.has(v.SKU)?v.Cantidad>p.skus.get(v.SKU):!0)),i.length>4&&(i=i.slice(0,4)),i});return(()=>{var i=Ot(),p=i.firstChild,v=p.firstChild,$=v.firstChild,T=v.nextSibling,x=T.firstChild,V=x.firstChild,D=x.nextSibling,y=D.firstChild,K=D.nextSibling,L=K.nextSibling;i.$$mouseover=n=>{n.stopPropagation(),a.onmouseover()},p.$$click=()=>{a.setProductoSelected(a.idx)},s(v,S,null),T.style.setProperty("grid-template-columns","1fr 3.8rem 2.8rem 5rem"),s(V,S),s(x,g(J,{get when(){return h()},get children(){var n=Ht();return n.style.setProperty("margin","0 -3px"),s(n,g(at,{get each(){return E()},children:U=>(()=>{var w=ot();return w.$$click=M=>{M.stopPropagation(),a.agregarProductoVenta(1,U.SKU)},s(w,()=>U.SKU),G(()=>C(w,`h5 ${I.producto_sku}`)),w})()})),n}}),null),s(x,g(J,{get when(){return!h()},get children(){return g(Jt,{onSelect:n=>{a.agregarProductoVenta(n)}})}}),null);var F=A;return typeof F=="function"?ct(F,y):A=y,s(K,m),s(L,()=>et(a.productoStock.producto.PrecioFinal/100,2)),G(n=>{var U=!!a.isSelected,w=!!h(),M=a.idx===0?"8px":void 0,R=rt("flex p-rel jc-between",I.card_venta),q=I.card_venta_nombre,j=I.card_venta_nombre_line,N=`h100 ${I.card_venta_producto_ctn}`,H={"flex ai-center":!h()},B=`${I.card_venta_producto}`,O=rt("p-rel flex ai-center",I.input_cantidad);return U!==n.e&&i.classList.toggle("sld",n.e=U),w!==n.t&&i.classList.toggle("sku",n.t=w),M!==n.a&&((n.a=M)!=null?i.style.setProperty("margin-top",M):i.style.removeProperty("margin-top")),R!==n.o&&C(p,n.o=R),q!==n.i&&C(v,n.i=q),j!==n.n&&C($,n.n=j),N!==n.s&&C(x,n.s=N),n.h=it(x,H,n.h),B!==n.r&&C(V,n.r=B),O!==n.d&&C(D,n.d=O),n},{e:void 0,t:void 0,a:void 0,o:void 0,i:void 0,n:void 0,s:void 0,h:void 0,r:void 0,d:void 0}),i})()};dt(["keyup","keydown","click","mouseover"]);export{oe as default};
